<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Form Data Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        input, select { margin: 5px; padding: 5px; }
        .form-group { margin: 10px 0; }
        .form-row { display: flex; gap: 10px; align-items: center; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>üîß Employee Form Data Test</h1>
    
    <div class="test-section info">
        <h2>üìã Current Issue Analysis</h2>
        <p><strong>Problem:</strong> Assets (phone/laptop assignments) not updating when editing employees</p>
        <p><strong>Root Cause:</strong> Checkbox values not properly converted in FormData ‚Üí JSON for PUT requests</p>
        <p><strong>Expected Backend Fields:</strong> first_name, last_name, email, phone, department, designation, status, is_phone_assigned, company_assigned_phone_number, is_laptop_assigned, company_assigned_laptop</p>
        <p><strong>Issue:</strong> Unchecked checkboxes were omitted from JSON, so backend didn't update them</p>
    </div>

    <div class="test-section">
        <h2>üß™ Form Data Investigation</h2>
        
        <h3>Simulated Employee Form Fields</h3>
        <form id="testForm">
            <div class="form-row">
                <label>First Name:</label>
                <input type="text" id="firstName" name="first_name" value="Updated John">
            </div>
            <div class="form-row">
                <label>Last Name:</label>
                <input type="text" id="lastName" name="last_name" value="Updated Doe">
            </div>
            <div class="form-row">
                <label>Email:</label>
                <input type="email" id="email" name="email" value="updated.john@company.com">
            </div>
            <div class="form-row">
                <label>Phone:</label>
                <input type="tel" id="phone" name="phone" value="+91 9876543211">
            </div>
            <div class="form-row">
                <label>Department:</label>
                <input type="text" id="department" name="department" value="Updated Engineering">
            </div>
            <div class="form-row">
                <label>Designation:</label>
                <input type="text" id="designation" name="designation" value="Updated Engineer">
            </div>
            <div class="form-row">
                <label>Status:</label>
                <select id="status" name="status">
                    <option value="ACTIVE" selected>Active</option>
                    <option value="INACTIVE">Inactive</option>
                </select>
            </div>
            
            <!-- Additional fields that the backend might ignore -->
            <div class="form-row">
                <label>Employee Code:</label>
                <input type="text" id="empCode" name="emp_code" value="EMP-2025-0001">
            </div>
            <div class="form-row">
                <label>Birth Date:</label>
                <input type="date" id="birthDate" name="birth_date" value="1990-01-15">
            </div>
            <div class="form-row">
                <label>Joining Date:</label>
                <input type="date" id="joiningDate" name="date_of_joining" value="2025-08-13">
            </div>
            
            <!-- Asset Fields for Testing -->
            <div class="form-row">
                <label>Phone Assigned:</label>
                <input type="checkbox" id="isPhoneAssigned" name="is_phone_assigned" checked>
                <input type="text" id="companyPhone" name="company_assigned_phone_number" value="+91 9876543210" placeholder="Company Phone">
            </div>
            <div class="form-row">
                <label>Laptop Assigned:</label>
                <input type="checkbox" id="isLaptopAssigned" name="is_laptop_assigned" checked>
                <input type="text" id="companyLaptop" name="company_assigned_laptop" value="Dell Laptop - 12345" placeholder="Company Laptop">
            </div>
        </form>
        
        <div style="margin: 20px 0;">
            <button onclick="testFormDataToJSON()">üìã Test FormData ‚Üí JSON Conversion</button>
            <button onclick="testLiveAPI()">üîó Test Live API Update</button>
            <button onclick="getCurrentEmployeeData()">üìÑ Get Current Employee Data</button>
        </div>
        
        <div id="testResults" class="result info" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üìä Test Results</h2>
        <div id="overallResults" class="result info">Ready to run tests...</div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/hr';
        const EMPLOYEE_ID = 18; // Test employee
        
        function showResult(message, type = 'info') {
            const div = document.getElementById('testResults');
            div.className = `result ${type}`;
            div.innerHTML = message;
            div.style.display = 'block';
        }
        
        function updateOverallResults(message, type = 'info') {
            const div = document.getElementById('overallResults');
            div.className = `result ${type}`;
            div.innerHTML = message;
        }
        
        function testFormDataToJSON() {
            showResult('üîÑ Testing FormData to JSON conversion...', 'info');
            
            const form = document.getElementById('testForm');
            const formData = new FormData(form);
            
            // Simulate the frontend conversion logic
            const jsonData = {};
            for (let [key, value] of formData.entries()) {
                jsonData[key] = value;
            }
            
            const expectedBackendFields = ['first_name', 'last_name', 'email', 'phone', 'department', 'designation', 'status', 'is_phone_assigned', 'company_assigned_phone_number', 'is_laptop_assigned', 'company_assigned_laptop'];
            const actualFields = Object.keys(jsonData);
            const backendFields = actualFields.filter(field => expectedBackendFields.includes(field));
            const ignoredFields = actualFields.filter(field => !expectedBackendFields.includes(field));
            
            const message = `
                <h4>‚úÖ FormData ‚Üí JSON Conversion Test</h4>
                <h5>üéØ Fields Backend Will Process (${backendFields.length}):</h5>
                <pre>${JSON.stringify(
                    backendFields.reduce((obj, field) => ({ ...obj, [field]: jsonData[field] }), {}), 
                    null, 2
                )}</pre>
                
                <h5>üö´ Fields Backend Will Ignore (${ignoredFields.length}):</h5>
                <pre>${JSON.stringify(
                    ignoredFields.reduce((obj, field) => ({ ...obj, [field]: jsonData[field] }), {}), 
                    null, 2
                )}</pre>
                
                <h5>üìä Full Form Data:</h5>
                <pre>${JSON.stringify(jsonData, null, 2)}</pre>
            `;
            
            showResult(message, 'success');
            updateOverallResults('FormData conversion working correctly. Backend will only process 7 fields.', 'info');
        }
        
        async function getCurrentEmployeeData() {
            try {
                showResult('üîÑ Getting current employee data...', 'info');
                
                const response = await fetch(`${API_BASE}/employees/${EMPLOYEE_ID}/`);
                
                if (response.ok) {
                    const employee = await response.json();
                    
                    const message = `
                        <h4>‚úÖ Current Employee Data</h4>
                        <h5>üéØ Fields Backend Can Update:</h5>
                        <pre>${JSON.stringify({
                            first_name: employee.first_name,
                            last_name: employee.last_name,
                            email: employee.email,
                            phone: employee.phone,
                            department: employee.department,
                            designation: employee.designation,
                            status: employee.status,
                            is_phone_assigned: employee.is_phone_assigned,
                            company_assigned_phone_number: employee.company_assigned_phone_number,
                            is_laptop_assigned: employee.is_laptop_assigned,
                            company_assigned_laptop: employee.company_assigned_laptop
                        }, null, 2)}</pre>
                        
                        <h5>üìä Full Employee Data:</h5>
                        <pre>${JSON.stringify(employee, null, 2)}</pre>
                    `;
                    
                    showResult(message, 'success');
                } else {
                    const error = await response.text();
                    showResult(`‚ùå Error: HTTP ${response.status}: ${error}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Network Error: ${error.message}`, 'error');
            }
        }
        
        async function testLiveAPI() {
            try {
                showResult('üîÑ Testing live API update...', 'info');
                
                const form = document.getElementById('testForm');
                const formData = new FormData(form);
                
                // Convert to JSON (simulating frontend)
                const jsonData = {};
                for (let [key, value] of formData.entries()) {
                    jsonData[key] = value;
                }
                
                // Filter to only backend-supported fields
                const supportedFields = ['first_name', 'last_name', 'email', 'phone', 'department', 'designation', 'status', 'is_phone_assigned', 'company_assigned_phone_number', 'is_laptop_assigned', 'company_assigned_laptop'];
                const apiData = {};
                supportedFields.forEach(field => {
                    if (jsonData[field] !== undefined) {
                        apiData[field] = jsonData[field];
                    }
                });
                
                console.log('Sending to API:', apiData);
                
                const response = await fetch(`${API_BASE}/employees/${EMPLOYEE_ID}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(apiData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Get updated data to verify
                    const updatedResponse = await fetch(`${API_BASE}/employees/${EMPLOYEE_ID}/`);
                    const updatedEmployee = await updatedResponse.json();
                    
                    const message = `
                        <h4>‚úÖ Live API Update Successful!</h4>
                        <p><strong>API Response:</strong> ${JSON.stringify(result)}</p>
                        
                        <h5>üîÑ Verification - Updated Employee Data:</h5>
                        <pre>${JSON.stringify({
                            first_name: updatedEmployee.first_name,
                            last_name: updatedEmployee.last_name,
                            email: updatedEmployee.email,
                            phone: updatedEmployee.phone,
                            department: updatedEmployee.department,
                            designation: updatedEmployee.designation,
                            status: updatedEmployee.status,
                            is_phone_assigned: updatedEmployee.is_phone_assigned,
                            company_assigned_phone_number: updatedEmployee.company_assigned_phone_number,
                            is_laptop_assigned: updatedEmployee.is_laptop_assigned,
                            company_assigned_laptop: updatedEmployee.company_assigned_laptop,
                            updated_at: updatedEmployee.updated_at
                        }, null, 2)}</pre>
                    `;
                    
                    showResult(message, 'success');
                    updateOverallResults('‚úÖ API update working correctly! Changes are being saved.', 'success');
                } else {
                    const error = await response.text();
                    showResult(`‚ùå API Error: HTTP ${response.status}: ${error}`, 'error');
                    updateOverallResults('‚ùå API update failed', 'error');
                }
            } catch (error) {
                showResult(`‚ùå Network Error: ${error.message}`, 'error');
                updateOverallResults('‚ùå Network error during API test', 'error');
            }
        }
        
        // Auto-run initial test
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testFormDataToJSON();
                setTimeout(getCurrentEmployeeData, 1000);
            }, 500);
        });
    </script>
</body>
</html>
