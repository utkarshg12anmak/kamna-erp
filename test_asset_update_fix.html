<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Update Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        input, select { margin: 5px; padding: 5px; }
        .checkbox-test { padding: 10px; border: 1px solid #ddd; margin: 10px 0; border-radius: 5px; }
        .test-result { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>üîß Asset Update Fix Test</h1>
    
    <div class="test-section info">
        <h2>üìã Issue: Assets Not Updating</h2>
        <p><strong>Problem:</strong> Phone and laptop assignments not updating when editing employees</p>
        <p><strong>Root Cause:</strong> Checkbox values not properly converted in FormData ‚Üí JSON for PUT requests</p>
        <p><strong>Fix:</strong> Enhanced FormData to JSON conversion to properly handle checkbox states</p>
    </div>

    <div class="test-section">
        <h2>üß™ Checkbox Handling Test</h2>
        <p>Testing how checkboxes behave in different states:</p>
        
        <form id="checkboxTestForm">
            <div class="checkbox-test">
                <h4>Phone Assignment Test</h4>
                <label>
                    <input type="checkbox" id="phoneChecked" name="is_phone_assigned" checked>
                    Phone Assigned (Currently Checked)
                </label>
                <input type="text" name="company_assigned_phone_number" value="+91 9876543210" placeholder="Phone Number">
            </div>
            
            <div class="checkbox-test">
                <h4>Laptop Assignment Test</h4>
                <label>
                    <input type="checkbox" id="laptopUnchecked" name="is_laptop_assigned">
                    Laptop Assigned (Currently Unchecked)
                </label>
                <input type="text" name="company_assigned_laptop" value="Dell Laptop 12345" placeholder="Laptop Details">
            </div>
            
            <div class="checkbox-test">
                <h4>Other Test Fields</h4>
                <input type="text" name="first_name" value="Asset Test">
                <input type="text" name="last_name" value="Employee">
                <input type="email" name="email" value="asset.test@company.com">
            </div>
        </form>
        
        <button onclick="testFormDataConversion()">üîÑ Test FormData Conversion</button>
        <button onclick="testJSONConversion()">üìÑ Test JSON Conversion (Fixed)</button>
        <button onclick="testLiveAssetUpdate()">üöÄ Test Live Asset Update</button>
        
        <div id="conversionResults" class="result info" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üìä Live API Test</h2>
        <p>Test the actual API with proper checkbox handling:</p>
        
        <div style="margin: 20px 0;">
            <button onclick="getCurrentAssetStatus()">üìÑ Get Current Asset Status</button>
            <button onclick="togglePhoneAsset()">üì± Toggle Phone Assignment</button>
            <button onclick="toggleLaptopAsset()">üíª Toggle Laptop Assignment</button>
            <button onclick="assignBothAssets()">üéØ Assign Both Assets</button>
            <button onclick="unassignBothAssets()">üö´ Unassign Both Assets</button>
        </div>
        
        <div id="apiResults" class="result info">Ready to test API...</div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/hr';
        const EMPLOYEE_ID = 18; // Test employee
        
        function showResult(elementId, message, type = 'info') {
            const div = document.getElementById(elementId);
            div.className = `result ${type}`;
            div.innerHTML = message;
            div.style.display = 'block';
        }
        
        function testFormDataConversion() {
            showResult('conversionResults', 'üîÑ Testing traditional FormData conversion...', 'info');
            
            const form = document.getElementById('checkboxTestForm');
            const formData = new FormData(form);
            
            const traditionalJSON = {};
            for (let [key, value] of formData.entries()) {
                traditionalJSON[key] = value;
            }
            
            const message = `
                <h4>‚ùå Traditional FormData ‚Üí JSON (BROKEN)</h4>
                <p><strong>Issue:</strong> Unchecked checkboxes are completely missing!</p>
                <pre>${JSON.stringify(traditionalJSON, null, 2)}</pre>
                <div class="test-result error">
                    ‚ùå is_laptop_assigned missing (because unchecked)<br>
                    ‚ùå Backend won't update unchecked fields
                </div>
            `;
            
            showResult('conversionResults', message, 'error');
        }
        
        function testJSONConversion() {
            showResult('conversionResults', 'üîÑ Testing fixed JSON conversion...', 'info');
            
            const form = document.getElementById('checkboxTestForm');
            const formElements = form.querySelectorAll('input, select, textarea');
            
            const fixedJSON = {};
            formElements.forEach(element => {
                const name = element.name;
                if (!name) return;
                
                if (element.type === 'checkbox') {
                    fixedJSON[name] = element.checked;
                } else {
                    fixedJSON[name] = element.value;
                }
            });
            
            const message = `
                <h4>‚úÖ Fixed JSON Conversion (WORKING)</h4>
                <p><strong>Fix:</strong> All checkboxes included with proper boolean values!</p>
                <pre>${JSON.stringify(fixedJSON, null, 2)}</pre>
                <div class="test-result success">
                    ‚úÖ is_phone_assigned: true (checked)<br>
                    ‚úÖ is_laptop_assigned: false (unchecked)<br>
                    ‚úÖ Backend will update both fields correctly
                </div>
            `;
            
            showResult('conversionResults', message, 'success');
        }
        
        async function getCurrentAssetStatus() {
            try {
                showResult('apiResults', 'üîÑ Getting current asset status...', 'info');
                
                const response = await fetch(`${API_BASE}/employees/${EMPLOYEE_ID}/`);
                
                if (response.ok) {
                    const employee = await response.json();
                    
                    const message = `
                        <h4>üìã Current Asset Status for Employee ${EMPLOYEE_ID}</h4>
                        <div class="test-result info">
                            <strong>Phone Assignment:</strong> ${employee.is_phone_assigned ? '‚úÖ Assigned' : '‚ùå Not Assigned'}<br>
                            <strong>Phone Number:</strong> ${employee.company_assigned_phone_number || 'None'}<br>
                            <strong>Laptop Assignment:</strong> ${employee.is_laptop_assigned ? '‚úÖ Assigned' : '‚ùå Not Assigned'}<br>
                            <strong>Laptop Details:</strong> ${employee.company_assigned_laptop || 'None'}<br>
                            <strong>Last Updated:</strong> ${new Date(employee.updated_at).toLocaleString()}
                        </div>
                        <h5>Full Employee Data:</h5>
                        <pre>${JSON.stringify(employee, null, 2)}</pre>
                    `;
                    
                    showResult('apiResults', message, 'success');
                } else {
                    const error = await response.text();
                    showResult('apiResults', `‚ùå Error: HTTP ${response.status}: ${error}`, 'error');
                }
            } catch (error) {
                showResult('apiResults', `‚ùå Network Error: ${error.message}`, 'error');
            }
        }
        
        async function makeAssetUpdate(updateData, description) {
            try {
                showResult('apiResults', `üîÑ ${description}...`, 'info');
                
                console.log('Sending asset update:', updateData);
                
                const response = await fetch(`${API_BASE}/employees/${EMPLOYEE_ID}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Get updated data to verify
                    const updatedResponse = await fetch(`${API_BASE}/employees/${EMPLOYEE_ID}/`);
                    const updatedEmployee = await updatedResponse.json();
                    
                    const message = `
                        <h4>‚úÖ ${description} Successful!</h4>
                        <p><strong>API Response:</strong> ${JSON.stringify(result)}</p>
                        
                        <h5>üîÑ Updated Asset Status:</h5>
                        <div class="test-result success">
                            <strong>Phone Assignment:</strong> ${updatedEmployee.is_phone_assigned ? '‚úÖ Assigned' : '‚ùå Not Assigned'}<br>
                            <strong>Phone Number:</strong> ${updatedEmployee.company_assigned_phone_number || 'None'}<br>
                            <strong>Laptop Assignment:</strong> ${updatedEmployee.is_laptop_assigned ? '‚úÖ Assigned' : '‚ùå Not Assigned'}<br>
                            <strong>Laptop Details:</strong> ${updatedEmployee.company_assigned_laptop || 'None'}<br>
                            <strong>Last Updated:</strong> ${new Date(updatedEmployee.updated_at).toLocaleString()}
                        </div>
                    `;
                    
                    showResult('apiResults', message, 'success');
                } else {
                    const error = await response.text();
                    showResult('apiResults', `‚ùå API Error: HTTP ${response.status}: ${error}`, 'error');
                }
            } catch (error) {
                showResult('apiResults', `‚ùå Network Error: ${error.message}`, 'error');
            }
        }
        
        async function togglePhoneAsset() {
            // Get current status first
            const response = await fetch(`${API_BASE}/employees/${EMPLOYEE_ID}/`);
            const employee = await response.json();
            
            const newPhoneStatus = !employee.is_phone_assigned;
            const updateData = {
                is_phone_assigned: newPhoneStatus,
                company_assigned_phone_number: newPhoneStatus ? '+91 9876543210' : ''
            };
            
            await makeAssetUpdate(updateData, `Toggle Phone Assignment to ${newPhoneStatus ? 'ASSIGNED' : 'UNASSIGNED'}`);
        }
        
        async function toggleLaptopAsset() {
            // Get current status first
            const response = await fetch(`${API_BASE}/employees/${EMPLOYEE_ID}/`);
            const employee = await response.json();
            
            const newLaptopStatus = !employee.is_laptop_assigned;
            const updateData = {
                is_laptop_assigned: newLaptopStatus,
                company_assigned_laptop: newLaptopStatus ? 'Dell Latitude 5520 - Asset #12345' : ''
            };
            
            await makeAssetUpdate(updateData, `Toggle Laptop Assignment to ${newLaptopStatus ? 'ASSIGNED' : 'UNASSIGNED'}`);
        }
        
        async function assignBothAssets() {
            const updateData = {
                is_phone_assigned: true,
                company_assigned_phone_number: '+91 9876543210',
                is_laptop_assigned: true,
                company_assigned_laptop: 'Dell Latitude 5520 - Asset #12345'
            };
            
            await makeAssetUpdate(updateData, 'Assign Both Phone and Laptop');
        }
        
        async function unassignBothAssets() {
            const updateData = {
                is_phone_assigned: false,
                company_assigned_phone_number: '',
                is_laptop_assigned: false,
                company_assigned_laptop: ''
            };
            
            await makeAssetUpdate(updateData, 'Unassign Both Phone and Laptop');
        }
        
        async function testLiveAssetUpdate() {
            showResult('conversionResults', 'üîÑ Testing live asset update with fixed conversion...', 'info');
            
            const form = document.getElementById('checkboxTestForm');
            const formElements = form.querySelectorAll('input, select, textarea');
            
            // Use the fixed conversion method
            const jsonData = {};
            formElements.forEach(element => {
                const name = element.name;
                if (!name) return;
                
                if (element.type === 'checkbox') {
                    jsonData[name] = element.checked;
                } else {
                    jsonData[name] = element.value;
                }
            });
            
            // Filter to only asset-related fields for this test
            const assetData = {
                is_phone_assigned: jsonData.is_phone_assigned,
                company_assigned_phone_number: jsonData.company_assigned_phone_number,
                is_laptop_assigned: jsonData.is_laptop_assigned,
                company_assigned_laptop: jsonData.company_assigned_laptop
            };
            
            console.log('Testing asset update with data:', assetData);
            
            try {
                const response = await fetch(`${API_BASE}/employees/${EMPLOYEE_ID}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(assetData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Get updated data to verify
                    const updatedResponse = await fetch(`${API_BASE}/employees/${EMPLOYEE_ID}/`);
                    const updatedEmployee = await updatedResponse.json();
                    
                    const message = `
                        <h4>‚úÖ Live Asset Update Test Successful!</h4>
                        <p><strong>Sent Data:</strong></p>
                        <pre>${JSON.stringify(assetData, null, 2)}</pre>
                        
                        <p><strong>API Response:</strong> ${JSON.stringify(result)}</p>
                        
                        <h5>üîÑ Verified Asset Status:</h5>
                        <div class="test-result success">
                            <strong>Phone:</strong> ${updatedEmployee.is_phone_assigned ? '‚úÖ Assigned' : '‚ùå Not Assigned'} 
                            (${updatedEmployee.company_assigned_phone_number || 'No number'})<br>
                            <strong>Laptop:</strong> ${updatedEmployee.is_laptop_assigned ? '‚úÖ Assigned' : '‚ùå Not Assigned'} 
                            (${updatedEmployee.company_assigned_laptop || 'No details'})
                        </div>
                    `;
                    
                    showResult('conversionResults', message, 'success');
                } else {
                    const error = await response.text();
                    showResult('conversionResults', `‚ùå API Error: HTTP ${response.status}: ${error}`, 'error');
                }
            } catch (error) {
                showResult('conversionResults', `‚ùå Network Error: ${error.message}`, 'error');
            }
        }
        
        // Auto-run initial test
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(getCurrentAssetStatus, 500);
        });
    </script>
</body>
</html>
