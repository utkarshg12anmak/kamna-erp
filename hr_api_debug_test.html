<!DOCTYPE html>
<html>
<head>
    <title>HR API Authentication Debug</title>
</head>
<body>
    <h1>HR API Authentication Debug</h1>
    <div id="debug-output"></div>
    
    <script>
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function debugEmployeesAPI() {
            const output = document.getElementById('debug-output');
            
            // Check available cookies
            output.innerHTML += '<h3>1. Cookie Information:</h3>';
            output.innerHTML += `<p>Document cookies: ${document.cookie}</p>`;
            
            // Check CSRF token sources
            const csrfFromForm = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            const csrfFromCookie = getCookie('csrftoken');
            
            output.innerHTML += '<h3>2. CSRF Token Sources:</h3>';
            output.innerHTML += `<p>From form field: ${csrfFromForm || 'NOT FOUND'}</p>`;
            output.innerHTML += `<p>From cookie: ${csrfFromCookie || 'NOT FOUND'}</p>`;
            
            // Test API call
            output.innerHTML += '<h3>3. API Call Test:</h3>';
            
            try {
                const csrfToken = csrfFromForm || csrfFromCookie;
                
                output.innerHTML += `<p>Using CSRF token: ${csrfToken || 'NONE'}</p>`;
                
                const response = await fetch('/api/hr/employees/', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': csrfToken || '',
                        'Content-Type': 'application/json',
                    }
                });
                
                output.innerHTML += `<p>Response status: ${response.status}</p>`;
                output.innerHTML += `<p>Response headers: ${JSON.stringify([...response.headers.entries()])}</p>`;
                
                const data = await response.text(); // Get as text first
                output.innerHTML += `<p>Response body: ${data}</p>`;
                
                // Try to parse as JSON
                try {
                    const jsonData = JSON.parse(data);
                    output.innerHTML += `<p>Parsed JSON type: ${Array.isArray(jsonData) ? 'Array' : 'Object'}</p>`;
                    if (Array.isArray(jsonData)) {
                        output.innerHTML += `<p>Array length: ${jsonData.length}</p>`;
                    } else {
                        output.innerHTML += `<p>Object keys: ${Object.keys(jsonData)}</p>`;
                    }
                } catch (e) {
                    output.innerHTML += `<p>JSON parse error: ${e.message}</p>`;
                }
                
            } catch (error) {
                output.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        // Add CSRF token to page for testing
        document.addEventListener('DOMContentLoaded', function() {
            // Add a hidden CSRF token field for testing
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = getCookie('csrftoken') || 'NO_CSRF_TOKEN';
            document.body.appendChild(csrfInput);
            
            debugEmployeesAPI();
        });
    </script>
</body>
</html>
