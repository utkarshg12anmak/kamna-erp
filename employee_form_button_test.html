<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Form Button Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .test-fail { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .test-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>ðŸ”§ Employee Form Save Button Test</h2>
        <p>This test replicates the employee form button structure to diagnose the issue.</p>
        
        <div id="testResults"></div>
        
        <!-- Replicate the exact button structure from employee_form.html -->
        <div class="d-flex gap-2 mb-4">
            <button type="button" id="saveAsDraft" class="btn btn-outline-secondary">Save as Draft</button>
            <button type="submit" form="employeeForm" class="btn btn-primary">Save Employee</button>
        </div>
        
        <!-- Replicate the form structure -->
        <form id="employeeForm" class="row g-3">
            <div class="col-md-6">
                <label for="firstName" class="form-label">First Name</label>
                <input type="text" class="form-control" id="firstName" name="first_name" required>
            </div>
            <div class="col-md-6">
                <label for="lastName" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="lastName" name="last_name">
            </div>
            <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email">
            </div>
            <div class="col-md-6">
                <label for="phone" class="form-label">Phone</label>
                <input type="tel" class="form-control" id="phone" name="phone" required>
            </div>
        </form>
        
        <div class="mt-4">
            <button class="btn btn-info" onclick="runTests()">ðŸ§ª Run Diagnostic Tests</button>
            <button class="btn btn-warning" onclick="testManualSave()">ðŸ”§ Test Manual Save</button>
        </div>
        
        <!-- Toast container -->
        <div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 11;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // Replicate the exact JavaScript from employee_form.html
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.getElementById('toastContainer').appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 3000);
    }
    
    function validateForm() {
        const firstName = document.getElementById('firstName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        
        if (!firstName) {
            showToast('First name is required', 'error');
            return false;
        }
        
        if (!phone) {
            showToast('Phone number is required', 'error');
            return false;
        }
        
        return true;
    }
    
    async function simulateEmployeeSave(formData, isDraft) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                const firstName = formData.get('first_name');
                if (!isDraft && !firstName) {
                    reject(new Error('First name is required'));
                    return;
                }
                resolve({ success: true, message: 'Employee saved successfully' });
            }, 1000);
        });
    }
    
    async function saveEmployee(isDraft = false) {
        logTest(`saveEmployee called with isDraft: ${isDraft}`);
        
        const form = document.getElementById('employeeForm');
        
        if (!isDraft) {
            if (!validateForm()) {
                logTest('Validation failed', 'fail');
                return;
            }
        }
        
        const formData = new FormData(form);
        
        if (isDraft) {
            formData.append('is_draft', 'true');
        }
        
        const saveButton = isDraft ? 
            document.getElementById('saveAsDraft') : 
            document.querySelector('button[form="employeeForm"]');
        
        const originalText = saveButton ? saveButton.textContent : 'Save Employee';
        
        if (saveButton) {
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
        }
        
        try {
            logTest('Starting save process...', 'info');
            await simulateEmployeeSave(formData, isDraft);
            
            const message = isDraft ? 
                'Employee saved as draft successfully!' : 
                'Employee saved successfully!';
            
            showToast(message, 'success');
            logTest(`Save completed: ${message}`, 'pass');
            
        } catch (error) {
            logTest(`Save error: ${error.message}`, 'fail');
            showToast('Error saving employee: ' + error.message, 'error');
        } finally {
            if (saveButton) {
                saveButton.disabled = false;
                saveButton.textContent = originalText;
            }
        }
    }
    
    // Exact event listener setup from employee_form.html
    document.addEventListener('DOMContentLoaded', function() {
        logTest('DOM Content Loaded - Setting up event listeners');
        
        const form = document.getElementById('employeeForm');
        const saveButton = document.querySelector('button[form="employeeForm"]');
        const saveAsDraftButton = document.getElementById('saveAsDraft');
        
        logTest(`Save button found: ${saveButton ? 'YES' : 'NO'}`);
        logTest(`Save as Draft button found: ${saveAsDraftButton ? 'YES' : 'NO'}`);
        
        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            logTest('Form submitted via Save Employee button');
            saveEmployee(false);
        });
        
        // Handle save as draft
        if (saveAsDraftButton) {
            saveAsDraftButton.addEventListener('click', function(e) {
                e.preventDefault();
                logTest('Save as Draft button clicked');
                saveEmployee(true);
            });
        }
        
        // Additional click handler for the save button (backup)
        if (saveButton) {
            saveButton.addEventListener('click', function(e) {
                e.preventDefault();
                logTest('Save Employee button clicked directly');
                saveEmployee(false);
            });
        }
        
        logTest('Event listeners setup complete', 'pass');
    });
    
    // Test utilities
    function logTest(message, type = 'info') {
        console.log(`TEST: ${message}`);
        
        const results = document.getElementById('testResults');
        const div = document.createElement('div');
        div.className = `test-result test-${type}`;
        div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
        results.appendChild(div);
        results.scrollTop = results.scrollHeight;
    }
    
    function runTests() {
        logTest('ðŸ§ª Starting diagnostic tests...', 'info');
        
        // Test 1: Element existence
        const form = document.getElementById('employeeForm');
        const saveButton = document.querySelector('button[form="employeeForm"]');
        const draftButton = document.getElementById('saveAsDraft');
        
        logTest(`Form element: ${form ? 'FOUND' : 'NOT FOUND'}`, form ? 'pass' : 'fail');
        logTest(`Save Employee button: ${saveButton ? 'FOUND' : 'NOT FOUND'}`, saveButton ? 'pass' : 'fail');
        logTest(`Save as Draft button: ${draftButton ? 'FOUND' : 'NOT FOUND'}`, draftButton ? 'pass' : 'fail');
        
        // Test 2: Event listeners
        if (saveButton) {
            logTest('Testing Save Employee button click...', 'info');
            saveButton.click();
        }
        
        setTimeout(() => {
            if (draftButton) {
                logTest('Testing Save as Draft button click...', 'info');
                draftButton.click();
            }
        }, 2000);
    }
    
    function testManualSave() {
        logTest('ðŸ”§ Testing manual save function call...', 'info');
        
        // Fill in test data
        document.getElementById('firstName').value = 'Test';
        document.getElementById('lastName').value = 'User';
        document.getElementById('email').value = 'test@example.com';
        document.getElementById('phone').value = '1234567890';
        
        logTest('Test data filled in', 'info');
        
        // Test direct function call
        saveEmployee(false).then(() => {
            logTest('Direct function call completed', 'pass');
        }).catch(error => {
            logTest(`Direct function call failed: ${error.message}`, 'fail');
        });
    }
    </script>
</body>
</html>
