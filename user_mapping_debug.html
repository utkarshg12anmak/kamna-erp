<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Mapping Debug</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-4">
        <h1>User Mapping Debug Tool</h1>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Debug Information</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugOutput" class="bg-light p-3" style="font-family: monospace; white-space: pre-wrap; height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Buttons</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="testEmployeesAPI()">Test Employees API</button>
                        <button class="btn btn-info mb-2" onclick="testAvailableUsersAPI()">Test Available Users API</button>
                        <button class="btn btn-warning mb-2" onclick="testAssignUser(1, 'Test Employee')">Test Assign User (ID: 1)</button>
                        <button class="btn btn-danger mb-2" onclick="testUnassignUser(1, 'testuser')">Test Unassign User (ID: 1)</button>
                        <button class="btn btn-secondary mb-2" onclick="clearDebug()">Clear Debug</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Page Integration Test</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success mb-2" onclick="loadAndTestEmployeesPage()">Load Real Employees Page</button>
                        <button class="btn btn-outline-primary mb-2" onclick="checkDependencies()">Check Dependencies</button>
                        <button class="btn btn-outline-info mb-2" onclick="testJavaScriptFunctions()">Test JS Functions</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 11;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://127.0.0.1:8000/api/hr';
        
        function log(message, type = 'info') {
            const debugOutput = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'ℹ️',
                'success': '✅',
                'error': '❌',
                'warning': '⚠️'
            };
            
            debugOutput.textContent += `[${timestamp}] ${typeIcon[type] || 'ℹ️'} ${message}\n`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }
        
        function clearDebug() {
            document.getElementById('debugOutput').textContent = '';
        }
        
        function showToast(message, type = 'info') {
            const toastHtml = `
                <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <strong class="me-auto">${type.toUpperCase()}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;
            
            const toastContainer = document.getElementById('toastContainer');
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
        
        async function testEmployeesAPI() {
            log('Testing Employees API...');
            try {
                const response = await fetch(`${API_BASE}/employees/`);
                log(`Response status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Success! Found ${data.length || data.results?.length || 'unknown'} employees`);
                    if (data.length > 0 || data.results?.length > 0) {
                        const employees = data.results || data;
                        log(`First employee: ${employees[0].first_name} ${employees[0].last_name} (ID: ${employees[0].id})`);
                    }
                } else {
                    const errorText = await response.text();
                    log(`Error: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
            }
        }
        
        async function testAvailableUsersAPI() {
            log('Testing Available Users API...');
            try {
                const response = await fetch(`${API_BASE}/available-users/`);
                log(`Response status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Success! Found ${data.length} available users`);
                    data.forEach(user => {
                        log(`  - ${user.username} (${user.first_name} ${user.last_name}) - ${user.email}`);
                    });
                } else {
                    const errorText = await response.text();
                    log(`Error: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
            }
        }
        
        async function testAssignUser(employeeId, employeeName) {
            log(`Testing Assign User for Employee ID: ${employeeId}...`);
            
            // First get available users
            try {
                const usersResponse = await fetch(`${API_BASE}/available-users/`);
                if (!usersResponse.ok) {
                    log(`Failed to fetch available users: ${usersResponse.status}`, 'error');
                    return;
                }
                
                const availableUsers = await usersResponse.json();
                log(`Found ${availableUsers.length} available users`);
                
                if (availableUsers.length === 0) {
                    log('No available users to assign', 'warning');
                    return;
                }
                
                // Try to assign the first available user
                const userToAssign = availableUsers[0];
                log(`Attempting to assign user: ${userToAssign.username} to employee ${employeeId}`);
                
                const csrfToken = getCookie('csrftoken');
                log(`CSRF Token: ${csrfToken ? 'Found' : 'Missing'}`);
                
                const assignResponse = await fetch(`${API_BASE}/employees/${employeeId}/assign-user/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken || ''
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        user_id: userToAssign.id
                    })
                });
                
                log(`Assign response: ${assignResponse.status} ${assignResponse.statusText}`);
                
                if (assignResponse.ok) {
                    const result = await assignResponse.json();
                    log(`Assignment successful: ${JSON.stringify(result)}`, 'success');
                } else {
                    const errorData = await assignResponse.text();
                    log(`Assignment failed: ${errorData}`, 'error');
                }
                
            } catch (error) {
                log(`Assignment error: ${error.message}`, 'error');
            }
        }
        
        async function testUnassignUser(employeeId, username) {
            log(`Testing Unassign User for Employee ID: ${employeeId}...`);
            
            try {
                const csrfToken = getCookie('csrftoken');
                
                const response = await fetch(`${API_BASE}/employees/${employeeId}/unassign-user/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken || ''
                    },
                    credentials: 'same-origin'
                });
                
                log(`Unassign response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`Unassignment successful: ${JSON.stringify(result)}`, 'success');
                } else {
                    const errorData = await response.text();
                    log(`Unassignment failed: ${errorData}`, 'error');
                }
                
            } catch (error) {
                log(`Unassignment error: ${error.message}`, 'error');
            }
        }
        
        function checkDependencies() {
            log('Checking JavaScript dependencies...');
            
            // Check Bootstrap
            if (typeof bootstrap !== 'undefined') {
                log('✅ Bootstrap loaded');
            } else {
                log('❌ Bootstrap not loaded', 'error');
            }
            
            // Check jQuery (optional)
            if (typeof $ !== 'undefined') {
                log('✅ jQuery loaded');
            } else {
                log('⚠️ jQuery not loaded (optional)', 'warning');
            }
            
            // Check FontAwesome icons
            const faIcon = document.querySelector('.fas, .fa');
            if (faIcon || document.querySelector('link[href*="font-awesome"]')) {
                log('✅ FontAwesome detected');
            } else {
                log('⚠️ FontAwesome not detected', 'warning');
            }
            
            // Check fetch API
            if (typeof fetch !== 'undefined') {
                log('✅ Fetch API available');
            } else {
                log('❌ Fetch API not available', 'error');
            }
        }
        
        function testJavaScriptFunctions() {
            log('Testing JavaScript functions from employees_list.html...');
            
            // Test if we can access the functions that should be available on the employees page
            const functionsToTest = [
                'assignUser',
                'confirmUserAssignment', 
                'unassignUser',
                'showUserSelectionModal',
                'getCookie'
            ];
            
            functionsToTest.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    log(`✅ Function ${funcName} is available`);
                } else {
                    log(`❌ Function ${funcName} is NOT available`, 'error');
                }
            });
        }
        
        async function loadAndTestEmployeesPage() {
            log('Loading employees page in iframe for testing...');
            
            // Create iframe to load the actual employees page
            const iframe = document.createElement('iframe');
            iframe.src = '/hr/employees/';
            iframe.style.width = '100%';
            iframe.style.height = '600px';
            iframe.style.border = '1px solid #ccc';
            iframe.style.marginTop = '10px';
            
            // Remove existing iframe if any
            const existingIframe = document.querySelector('iframe');
            if (existingIframe) {
                existingIframe.remove();
            }
            
            document.body.appendChild(iframe);
            
            iframe.onload = function() {
                log('Employees page loaded in iframe');
                
                try {
                    // Try to access the iframe content (may fail due to CORS)
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    log('Iframe content accessible');
                    
                    // Check if assign user buttons exist
                    const assignButtons = iframeDoc.querySelectorAll('button[onclick*="assignUser"]');
                    log(`Found ${assignButtons.length} assign user buttons`);
                    
                    const unassignButtons = iframeDoc.querySelectorAll('button[onclick*="unassignUser"]');
                    log(`Found ${unassignButtons.length} unassign user buttons`);
                    
                } catch (error) {
                    log(`Cannot access iframe content (normal for cross-origin): ${error.message}`, 'warning');
                }
            };
            
            iframe.onerror = function() {
                log('Failed to load employees page', 'error');
            };
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Debug tool loaded successfully');
            log('Click the test buttons to debug user mapping functionality');
        });
    </script>
</body>
</html>
