
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-sitemap text-primary"></i> Organizational Chart</h2>
        <p class="text-muted mb-0">Company structure and hierarchy visualization</p>
    </div>
    <div>
        <button class="btn btn-outline-primary" onclick="window.print()">
            <i class="fas fa-print"></i> Print Chart
        </button>
        <a href="{% url 'hr_employees' %}" class="btn btn-primary">
            <i class="fas fa-users"></i> Employee List
        </a>
    </div>
</div>

<!-- Organization Statistics -->
<div class="org-stats">
    <div class="row">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number" id="totalEmployees">-</div>
                <div class="stat-label">Total Employees</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                <div class="stat-number" id="totalManagers">-</div>
                <div class="stat-label">Managers</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                <div class="stat-number" id="totalDepartments">-</div>
                <div class="stat-label">Departments</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                <div class="stat-number" id="avgTeamSize">-</div>
                <div class="stat-label">Avg Team Size</div>
            </div>
        </div>
    </div>
</div>

<!-- View Controls -->
<div class="org-actions">
    <div class="row align-items-center">
        <div class="col-md-4">
            <div class="view-toggle">
                <label class="form-label"><strong>View Type:</strong></label>
                <select class="form-select" id="viewType">
                    <option value="hierarchy">Hierarchy View</option>
                    <option value="department">Department View</option>
                    <option value="compact">Compact View</option>
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <label class="form-label"><strong>Department Filter:</strong></label>
            <select class="form-select" id="departmentFilter">
                <option value="">All Departments</option>
                <!-- Department options will be populated dynamically from API data -->
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label"><strong>Search Employee:</strong></label>
            <input type="text" class="form-control" id="employeeSearch" 
                   placeholder="Search by name or position...">
        </div>
    </div>
</div>

<!-- Organizational Chart -->
<div class="org-chart" id="orgChart">
    <!-- Chart will be populated dynamically from API data -->
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading organizational chart...</p>
    </div>
</div>

<!-- Legend -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">Legend</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="org-node ceo me-3" style="transform: scale(0.3); margin: 0;">
                                <div class="employee-photo"><i class="fas fa-user-tie"></i></div>
                            </div>
                            <span>Executive Level</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="org-node manager me-3" style="transform: scale(0.3); margin: 0;">
                                <div class="employee-photo"><i class="fas fa-user-friends"></i></div>
                            </div>
                            <span>Management Level</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="org-node employee me-3" style="transform: scale(0.3); margin: 0;">
                                <div class="employee-photo"><i class="fas fa-user"></i></div>
                            </div>
                            <span>Employee Level</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Click on any employee to view details
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .org-chart {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        position: relative;
    }
    
    .org-node {
        background: white;
        border: 2px solid #3C83F6;
        border-radius: 8px;
        padding: 15px;
        margin: 10px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        position: relative;
        min-width: 200px;
        cursor: pointer;
    }
    
    .org-node:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .org-node.ceo {
        border-color: #dc3545;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }
    
    .org-node.manager {
        border-color: #28a745;
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        color: white;
    }
    
    .org-node.employee {
        border-color: #3C83F6;
        background: linear-gradient(135deg, #3C83F6 0%, #2563eb 100%);
        color: white;
    }
    
    .org-node.highlighted {
        border-color: #ffc107 !important;
        box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.3);
    }
    
    .org-node.compact {
        transform: scale(0.8);
        margin: 5px;
    }
    
    .employee-photo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 10px;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    
    .employee-name {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 5px;
    }
    
    .employee-title {
        font-size: 14px;
        margin-bottom: 5px;
        opacity: 0.9;
    }
    
    .employee-department {
        font-size: 12px;
        opacity: 0.8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .org-level {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }
    
    .org-stats .stat-card {
        background: linear-gradient(135deg, #3C83F6 0%, #2563eb 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .stat-number {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }
    
    .org-actions {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .department-group {
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize org chart
    initializeOrgChart();
    
    // Add click handlers for employee nodes
    document.querySelectorAll('.org-node').forEach(node => {
        node.addEventListener('click', function() {
            showEmployeeDetails(this);
        });
    });
    
    // Add event listeners for form controls
    document.getElementById('viewType').addEventListener('change', changeView);
    document.getElementById('departmentFilter').addEventListener('change', filterDepartment);
    document.getElementById('employeeSearch').addEventListener('keyup', searchEmployee);
});

async function loadOrgChartData() {
    try {
        console.log('üì° Loading employee data for org chart...');
        
        // Fetch employees from API
        const response = await fetch('/api/hr/employees/');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const employees = await response.json();
        console.log(`‚úÖ Loaded ${employees.length} employees`);
        
        // Build organizational hierarchy
        const orgData = buildOrgHierarchy(employees);
        
        // Render org chart
        renderOrgChart(orgData);
        
        // Update department filter options
        updateDepartmentFilter(employees);
        
    } catch (error) {
        console.error('‚ùå Error loading org chart data:', error);
        
        // Fallback to show error message
        const chartContainer = document.getElementById('orgChart');
        chartContainer.innerHTML = `
            <div class="alert alert-warning text-center">
                <h5>‚ö†Ô∏è Unable to load organization data</h5>
                <p>Error: ${error.message}</p>
                <p class="mb-0">The chart is currently showing placeholder data.</p>
            </div>
        `;
    }
}

function buildOrgHierarchy(employees) {
    // Group employees by manager relationship
    const employeeMap = new Map();
    const managerMap = new Map();
    
    // First pass: create employee map
    employees.forEach(emp => {
        employeeMap.set(emp.id, emp);
        if (emp.manager) {
            if (!managerMap.has(emp.manager)) {
                managerMap.set(emp.manager, []);
            }
            managerMap.get(emp.manager).push(emp);
        }
    });
    
    // Find root employees (no manager or manager not in system)
    const roots = employees.filter(emp => 
        !emp.manager || !employeeMap.has(emp.manager)
    );
    
    console.log(`Found ${roots.length} root employees`);
    
    return {
        employees: employeeMap,
        managerMap: managerMap,
        roots: roots
    };
}

function renderOrgChart(orgData) {
    const chartContainer = document.getElementById('orgChart');
    
    if (orgData.roots.length === 0) {
        chartContainer.innerHTML = `
            <div class="alert alert-info text-center">
                <h5>‚ÑπÔ∏è No employees found</h5>
                <p class="mb-0">Add employees to see the organizational chart.</p>
            </div>
        `;
        return;
    }
    
    let chartHTML = '';
    
    // Group employees by hierarchy level
    const levels = organizeLevelsByHierarchy(orgData);
    
    levels.forEach((levelEmployees, levelIndex) => {
        chartHTML += `<div class="org-level" data-level="${levelIndex}">`;
        
        levelEmployees.forEach(employee => {
            const nodeClass = getEmployeeNodeClass(employee, orgData);
            const department = employee.department || 'unassigned';
            const fullName = `${employee.first_name} ${employee.last_name}`;
            const position = employee.designation || employee.position?.title || 'Employee';
            
            chartHTML += `
                <div class="org-node ${nodeClass}" 
                     data-department="${department.toLowerCase()}" 
                     data-name="${fullName.toLowerCase()}" 
                     data-position="${position.toLowerCase()}"
                     data-employee-id="${employee.id}">
                    <div class="employee-photo">
                        ${employee.profile_image ? 
                            `<img src="${employee.profile_image}" alt="${fullName}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` :
                            `<i class="fas fa-user"></i>`
                        }
                    </div>
                    <div class="employee-name">${fullName}</div>
                    <div class="employee-title">${position}</div>
                    <div class="employee-department">${employee.department || 'Unassigned'}</div>
                </div>
            `;
        });
        
        chartHTML += '</div>';
    });
    
    chartContainer.innerHTML = chartHTML;
    
    // Re-attach event listeners
    document.querySelectorAll('.org-node').forEach(node => {
        node.addEventListener('click', function() {
            showEmployeeDetails(this);
        });
    });
    
    console.log('‚úÖ Org chart rendered successfully');
}

function organizeLevelsByHierarchy(orgData) {
    const levels = [];
    const processed = new Set();
    
    // Level 0: Root employees (CEO, top executives)
    const ceoLevel = orgData.roots.filter(emp => 
        !emp.manager && (
            emp.designation?.toLowerCase().includes('ceo') ||
            emp.designation?.toLowerCase().includes('chief') ||
            emp.designation?.toLowerCase().includes('president') ||
            emp.designation?.toLowerCase().includes('director')
        )
    );
    
    if (ceoLevel.length > 0) {
        levels.push(ceoLevel);
        ceoLevel.forEach(emp => processed.add(emp.id));
    }
    
    // Level 1: Department heads and senior managers
    const managerLevel = orgData.roots.filter(emp => 
        !processed.has(emp.id) && (
            orgData.managerMap.has(emp.id) || // Has direct reports
            emp.designation?.toLowerCase().includes('manager') ||
            emp.designation?.toLowerCase().includes('head') ||
            emp.designation?.toLowerCase().includes('lead')
        )
    );
    
    if (managerLevel.length > 0) {
        levels.push(managerLevel);
        managerLevel.forEach(emp => processed.add(emp.id));
    }
    
    // Level 2+: Everyone else
    const remaining = orgData.roots.filter(emp => !processed.has(emp.id));
    if (remaining.length > 0) {
        levels.push(remaining);
    }
    
    return levels;
}

function getEmployeeNodeClass(employee, orgData) {
    const designation = employee.designation?.toLowerCase() || '';
    
    if (designation.includes('ceo') || designation.includes('chief') || designation.includes('president')) {
        return 'ceo';
    }
    
    if (orgData.managerMap.has(employee.id) || 
        designation.includes('manager') || 
        designation.includes('director') || 
        designation.includes('head') || 
        designation.includes('lead')) {
        return 'manager';
    }
    
    return 'employee';
}

function updateDepartmentFilter(employees) {
    const departments = new Set();
    employees.forEach(emp => {
        if (emp.department) {
            departments.add(emp.department);
        }
    });
    
    const departmentFilter = document.getElementById('departmentFilter');
    
    // Clear existing options (except "All Departments")
    const options = departmentFilter.querySelectorAll('option:not(:first-child)');
    options.forEach(option => option.remove());
    
    // Add departments from actual data
    Array.from(departments).sort().forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.toLowerCase();
        option.textContent = dept;
        departmentFilter.appendChild(option);
    });
}

async function initializeOrgChart() {
    // Load organization data from API
    await loadOrgChartData();
    updateStats();
}

function updateStats() {
    // Update statistics using vanilla JavaScript
    const allNodes = document.querySelectorAll('.org-node');
    const managerNodes = document.querySelectorAll('.org-node.manager, .org-node.ceo');
    const departments = new Set();
    
    allNodes.forEach(node => {
        const dept = node.getAttribute('data-department');
        if (dept) departments.add(dept);
    });
    
    const stats = {
        totalEmployees: allNodes.length,
        totalManagers: managerNodes.length,
        totalDepartments: departments.size,
        avgTeamSize: managerNodes.length > 0 ? (allNodes.length / managerNodes.length).toFixed(1) : '0'
    };
    
    document.getElementById('totalEmployees').textContent = stats.totalEmployees;
    document.getElementById('totalManagers').textContent = stats.totalManagers;
    document.getElementById('totalDepartments').textContent = stats.totalDepartments;
    document.getElementById('avgTeamSize').textContent = stats.avgTeamSize;
}

function changeView() {
    const viewType = document.getElementById('viewType').value;
    const chart = document.getElementById('orgChart');
    
    // Remove existing view classes
    chart.classList.remove('hierarchy-view', 'department-view', 'compact-view');
    chart.classList.add(viewType + '-view');
    
    switch(viewType) {
        case 'hierarchy':
            showHierarchyView();
            break;
        case 'department':
            showDepartmentView();
            break;
        case 'compact':
            showCompactView();
            break;
    }
}

function showHierarchyView() {
    // Default hierarchy view - show all levels
    document.querySelectorAll('.org-level').forEach(level => {
        level.style.display = 'flex';
    });
    document.querySelectorAll('.org-node').forEach(node => {
        node.style.display = 'block';
        node.classList.remove('compact');
    });
}

function showDepartmentView() {
    // Group by departments
    const departments = {};
    const allNodes = document.querySelectorAll('.org-node');
    
    allNodes.forEach(node => {
        const dept = node.getAttribute('data-department');
        if (!departments[dept]) {
            departments[dept] = [];
        }
        departments[dept].push(node.cloneNode(true));
    });
    
    // Reorganize display by departments
    let html = '';
    Object.keys(departments).forEach(dept => {
        html += `<div class="department-group">
                   <h5 class="text-primary text-center mb-3">${dept.toUpperCase()}</h5>
                   <div class="org-level">`;
        departments[dept].forEach(node => {
            html += node.outerHTML;
        });
        html += '</div></div>';
    });
    
    document.getElementById('orgChart').innerHTML = html;
    
    // Re-attach event listeners
    document.querySelectorAll('.org-node').forEach(node => {
        node.addEventListener('click', function() {
            showEmployeeDetails(this);
        });
    });
}

function showCompactView() {
    // Compact view with smaller nodes
    document.querySelectorAll('.org-node').forEach(node => {
        node.classList.add('compact');
    });
}

function filterDepartment() {
    const department = document.getElementById('departmentFilter').value;
    const allNodes = document.querySelectorAll('.org-node');
    
    if (department === '') {
        allNodes.forEach(node => {
            node.style.display = 'block';
        });
    } else {
        allNodes.forEach(node => {
            const nodeDept = node.getAttribute('data-department');
            node.style.display = nodeDept === department ? 'block' : 'none';
        });
    }
    
    updateStats();
}

function searchEmployee() {
    const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
    const allNodes = document.querySelectorAll('.org-node');
    
    if (searchTerm === '') {
        allNodes.forEach(node => {
            node.style.display = 'block';
            node.classList.remove('highlighted');
        });
    } else {
        allNodes.forEach(node => {
            const name = node.getAttribute('data-name') || '';
            const position = node.getAttribute('data-position') || '';
            
            if (name.includes(searchTerm) || position.includes(searchTerm)) {
                node.style.display = 'block';
                node.classList.add('highlighted');
            } else {
                node.style.display = 'none';
                node.classList.remove('highlighted');
            }
        });
    }
}

function showEmployeeDetails(node) {
    const employeeId = node.getAttribute('data-employee-id');
    const employeeName = node.querySelector('.employee-name').textContent;
    const employeeTitle = node.querySelector('.employee-title').textContent;
    const employeeDepartment = node.querySelector('.employee-department').textContent;
    
    // Create and show modal
    let modal = document.getElementById('employeeModal');
    if (!modal) {
        modal = createEmployeeModal();
    }
    
    // Populate modal with employee data
    document.getElementById('modalEmployeeName').textContent = employeeName;
    document.getElementById('modalEmployeeTitle').textContent = employeeTitle;
    document.getElementById('modalEmployeeDepartment').textContent = employeeDepartment;
    
    // Update "View Full Profile" button with employee ID
    const viewProfileBtn = modal.querySelector('.btn-primary');
    if (employeeId) {
        viewProfileBtn.onclick = () => {
            window.location.href = `/app/hr/employees/${employeeId}`;
        };
        viewProfileBtn.style.display = 'inline-block';
    } else {
        viewProfileBtn.style.display = 'none';
    }
    
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

function createEmployeeModal() {
    const modalHtml = `
    <div class="modal fade" id="employeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEmployeeName">Employee Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Position:</strong> <span id="modalEmployeeTitle"></span></p>
                    <p><strong>Department:</strong> <span id="modalEmployeeDepartment"></span></p>
                    <p><strong>Status:</strong> <span class="badge bg-success">Active</span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">View Full Profile</button>
                </div>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    return document.getElementById('employeeModal');
}

// Export functionality
function exportOrgChart() {
    const chartData = [];
    document.querySelectorAll('.org-node').forEach(node => {
        chartData.push({
            name: node.querySelector('.employee-name').textContent,
            title: node.querySelector('.employee-title').textContent,
            department: node.querySelector('.employee-department').textContent,
            level: node.classList.contains('ceo') ? 'Executive' : 
                   node.classList.contains('manager') ? 'Manager' : 'Employee'
        });
    });
    
    // Convert to CSV
    const csv = convertToCSV(chartData);
    downloadCSV(csv, 'organizational_chart.csv');
}

function convertToCSV(data) {
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
    ].join('\n');
    
    return csvContent;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
