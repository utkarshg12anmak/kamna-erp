<!-- HR Organizational Chart Content Template -->
<!-- Hidden CSRF token for API requests -->
{% csrf_token %}

<style>
    .org-chart {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        position: relative;
    }
    
    .org-node {
        background: white;
        border: 2px solid #3C83F6;
        border-radius: 8px;
        padding: 15px;
        margin: 10px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        position: relative;
        min-width: 200px;
    }
    
    .org-node:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .org-node.ceo {
        border-color: #dc3545;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }
    
    .org-node.manager {
        border-color: #28a745;
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        color: white;
    }
    
    .org-node.employee {
        border-color: #3C83F6;
        background: linear-gradient(135deg, #3C83F6 0%, #2563eb 100%);
        color: white;
    }
    
    .employee-photo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 10px;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #6c757d;
    }
    
    .employee-name {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 5px;
    }
    
    .employee-title {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 5px;
    }
    
    .employee-department {
        font-size: 12px;
        opacity: 0.8;
    }
    
    .org-level {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        margin: 30px 0;
    }
    
    .org-stats {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-card {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        background: linear-gradient(135deg, #3C83F6 0%, #2563eb 100%);
        color: white;
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }
    
    .org-actions {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .org-node.highlighted {
        border-color: #ffc107 !important;
        box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.3);
    }
    
    .org-node.compact {
        min-width: 150px;
        padding: 10px;
        margin: 5px;
    }
    
    .org-node.compact .employee-photo {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
    
    .org-node.compact .employee-name {
        font-size: 14px;
    }
    
    .org-node.compact .employee-title {
        font-size: 12px;
    }
    
    @media print {
        .org-actions, .btn {
            display: none !important;
        }
        
        .org-chart {
            background: white !important;
            box-shadow: none !important;
        }
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-sitemap text-primary"></i> Organizational Chart</h2>
        <p class="text-muted mb-0">Company structure and hierarchy visualization</p>
    </div>
    <div>
        <button class="btn btn-outline-primary" onclick="window.print()">
            <i class="fas fa-print"></i> Print Chart
        </button>
        <a href="/app/hr/employees" class="btn btn-primary">
            <i class="fas fa-users"></i> Employee List
        </a>
    </div>
</div>

<!-- Organization Statistics -->
<div class="org-stats">
    <div class="row">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number" id="totalEmployees">-</div>
                <div class="stat-label">Total Employees</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                <div class="stat-number" id="totalManagers">-</div>
                <div class="stat-label">Managers</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                <div class="stat-number" id="totalDepartments">-</div>
                <div class="stat-label">Departments</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                <div class="stat-number" id="avgTeamSize">-</div>
                <div class="stat-label">Avg Team Size</div>
            </div>
        </div>
    </div>
</div>

<!-- View Controls -->
<div class="org-actions">
    <div class="row align-items-center">
        <div class="col-md-4">
            <label class="form-label"><strong>View Type:</strong></label>
            <select class="form-select" id="viewType" onchange="changeView()">
                <option value="hierarchy">Hierarchy View</option>
                <option value="department">Department View</option>
                <option value="compact">Compact View</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label"><strong>Department Filter:</strong></label>
            <select class="form-select" id="departmentFilter" onchange="filterDepartment()">
                <option value="">All Departments</option>
                <!-- Department options will be populated dynamically -->
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label"><strong>Search Employee:</strong></label>
            <input type="text" class="form-control" id="employeeSearch" 
                   placeholder="Search by name or position..." onkeyup="searchEmployee()">
        </div>
    </div>
</div>

<!-- Organizational Chart -->
<div class="org-chart" id="orgChart">
    <!-- Dynamic content will be loaded here -->
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading organizational chart...</p>
    </div>
</div>

<!-- Legend -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">Legend</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="org-node ceo me-3" style="transform: scale(0.3); margin: 0;">
                                <div class="employee-photo"><i class="fas fa-user-tie"></i></div>
                            </div>
                            <span>Executive Level</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="org-node manager me-3" style="transform: scale(0.3); margin: 0;">
                                <div class="employee-photo"><i class="fas fa-user-friends"></i></div>
                            </div>
                            <span>Management Level</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="org-node employee me-3" style="transform: scale(0.3); margin: 0;">
                                <div class="employee-photo"><i class="fas fa-user"></i></div>
                            </div>
                            <span>Employee Level</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Click on any employee to view details
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize org chart
    initializeOrgChart();
    
    // Add click handlers for employee nodes
    document.querySelectorAll('.org-node').forEach(node => {
        node.addEventListener('click', function() {
            showEmployeeDetails(this);
        });
    });
});

function initializeOrgChart() {
    // Load organization data from API
    loadOrgChartData();
}

async function loadOrgChartData() {
    try {
        console.log('📡 Loading employee data for org chart...');
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value 
          || getCookie('csrftoken');
        
        // Fetch employees from API with session authentication
        const response = await fetch('/api/hr/employees/', {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrfToken || '',
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const employees = await response.json();
        
        // Verify that employees is an array
        if (!Array.isArray(employees)) {
            console.error('❌ API returned non-array data:', employees);
            throw new Error('Invalid data format: expected array of employees');
        }
        
        console.log(`✅ Loaded ${employees.length} employees`);
        
        // Build organizational hierarchy
        const orgData = buildOrgHierarchy(employees);
        
        // Render org chart
        renderOrgChart(orgData);
        
        // Update department filter options
        updateDepartmentFilter(employees);
        
        // Update stats
        updateStats();
        
    } catch (error) {
        console.error('❌ Error loading org chart data:', error);
        
        // Fallback to show error message
        const chartContainer = document.getElementById('orgChart');
        chartContainer.innerHTML = `
            <div class="alert alert-warning text-center">
                <h5>⚠️ Unable to load organization data</h5>
                <p>Error: ${error.message}</p>
                <p class="mb-0">Please check your connection and try again.</p>
            </div>
        `;
    }
}

function buildOrgHierarchy(employees) {
    // Group employees by manager relationship
    const employeeMap = new Map();
    const managerMap = new Map();
    
    // First pass: create employee map
    employees.forEach(emp => {
        employeeMap.set(emp.id, emp);
        if (emp.manager) {
            if (!managerMap.has(emp.manager)) {
                managerMap.set(emp.manager, []);
            }
            managerMap.get(emp.manager).push(emp);
        }
    });
    
    // Find root employees (no manager or manager not in system)
    const roots = employees.filter(emp => 
        !emp.manager || !employeeMap.has(emp.manager)
    );
    
    console.log(`Found ${roots.length} root employees`);
    
    return {
        employees: employeeMap,
        managerMap: managerMap,
        roots: roots
    };
}

function renderOrgChart(orgData) {
    const chartContainer = document.getElementById('orgChart');
    
    if (orgData.roots.length === 0) {
        chartContainer.innerHTML = `
            <div class="alert alert-info text-center">
                <h5>ℹ️ No employees found</h5>
                <p class="mb-0">Add employees to see the organizational chart.</p>
            </div>
        `;
        return;
    }
    
    let chartHTML = '';
    
    // Group employees by hierarchy level
    const levels = organizeLevelsByHierarchy(orgData);
    
    levels.forEach((levelEmployees, levelIndex) => {
        chartHTML += `<div class="org-level" data-level="${levelIndex}">`;
        
        levelEmployees.forEach(employee => {
            const nodeClass = getEmployeeNodeClass(employee, orgData);
            const department = employee.department || 'unassigned';
            const fullName = `${employee.first_name} ${employee.last_name}`;
            const position = employee.designation || employee.position?.title || 'Employee';
            
            chartHTML += `
                <div class="org-node ${nodeClass}" 
                     data-department="${department.toLowerCase()}" 
                     data-name="${fullName.toLowerCase()}" 
                     data-position="${position.toLowerCase()}"
                     data-employee-id="${employee.id}">
                    <div class="employee-photo">
                        ${employee.profile_image ? 
                            `<img src="${employee.profile_image}" alt="${fullName}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` :
                            `<i class="fas fa-user"></i>`
                        }
                    </div>
                    <div class="employee-name">${fullName}</div>
                    <div class="employee-title">${position}</div>
                    <div class="employee-department">${employee.department || 'Unassigned'}</div>
                </div>
            `;
        });
        
        chartHTML += '</div>';
    });
    
    chartContainer.innerHTML = chartHTML;
    
    // Re-attach event listeners
    document.querySelectorAll('.org-node').forEach(node => {
        node.addEventListener('click', function() {
            showEmployeeDetails(this);
        });
    });
    
    console.log('✅ Org chart rendered successfully');
}

function organizeLevelsByHierarchy(orgData) {
    const levels = [];
    const processed = new Set();
    
    // Level 0: Root employees (CEO, top executives)
    const ceoLevel = orgData.roots.filter(emp => 
        !emp.manager && (
            emp.designation?.toLowerCase().includes('ceo') ||
            emp.designation?.toLowerCase().includes('chief') ||
            emp.designation?.toLowerCase().includes('president') ||
            emp.designation?.toLowerCase().includes('director')
        )
    );
    
    if (ceoLevel.length > 0) {
        levels.push(ceoLevel);
        ceoLevel.forEach(emp => processed.add(emp.id));
    }
    
    // Level 1: Department heads and senior managers
    const managerLevel = orgData.roots.filter(emp => 
        !processed.has(emp.id) && (
            orgData.managerMap.has(emp.id) || // Has direct reports
            emp.designation?.toLowerCase().includes('manager') ||
            emp.designation?.toLowerCase().includes('head') ||
            emp.designation?.toLowerCase().includes('lead')
        )
    );
    
    if (managerLevel.length > 0) {
        levels.push(managerLevel);
        managerLevel.forEach(emp => processed.add(emp.id));
    }
    
    // Level 2+: Everyone else
    const remaining = orgData.roots.filter(emp => !processed.has(emp.id));
    if (remaining.length > 0) {
        levels.push(remaining);
    }
    
    return levels;
}

function getEmployeeNodeClass(employee, orgData) {
    const designation = employee.designation?.toLowerCase() || '';
    
    if (designation.includes('ceo') || designation.includes('chief') || designation.includes('president')) {
        return 'ceo';
    }
    
    if (orgData.managerMap.has(employee.id) || 
        designation.includes('manager') || 
        designation.includes('director') || 
        designation.includes('head') || 
        designation.includes('lead')) {
        return 'manager';
    }
    
    return 'employee';
}

function updateDepartmentFilter(employees) {
    const departments = new Set();
    employees.forEach(emp => {
        if (emp.department) {
            departments.add(emp.department);
        }
    });
    
    const departmentFilter = document.getElementById('departmentFilter');
    
    // Clear existing options (except "All Departments")
    const options = departmentFilter.querySelectorAll('option:not(:first-child)');
    options.forEach(option => option.remove());
    
    // Add departments from actual data
    Array.from(departments).sort().forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.toLowerCase();
        option.textContent = dept;
        departmentFilter.appendChild(option);
    });
}

function updateStats() {
    // Update statistics
    const nodes = document.querySelectorAll('.org-node');
    const managers = document.querySelectorAll('.org-node.manager, .org-node.ceo');
    const departments = new Set();
    
    nodes.forEach(node => {
        const dept = node.getAttribute('data-department');
        if (dept) departments.add(dept);
    });
    
    const stats = {
        totalEmployees: nodes.length,
        totalManagers: managers.length,
        totalDepartments: departments.size,
        avgTeamSize: managers.length > 0 ? (nodes.length / managers.length).toFixed(1) : '0'
    };
    
    document.getElementById('totalEmployees').textContent = stats.totalEmployees;
    document.getElementById('totalManagers').textContent = stats.totalManagers;
    document.getElementById('totalDepartments').textContent = stats.totalDepartments;
    document.getElementById('avgTeamSize').textContent = stats.avgTeamSize;
}

function changeView() {
    const viewType = document.getElementById('viewType').value;
    const chart = document.getElementById('orgChart');
    
    chart.classList.remove('hierarchy-view', 'department-view', 'compact-view');
    chart.classList.add(viewType + '-view');
    
    switch(viewType) {
        case 'hierarchy':
            showHierarchyView();
            break;
        case 'department':
            showDepartmentView();
            break;
        case 'compact':
            showCompactView();
            break;
    }
}

function showHierarchyView() {
    // Default hierarchy view - already implemented
    document.querySelectorAll('.org-level').forEach(level => {
        level.style.display = 'flex';
    });
    document.querySelectorAll('.org-node').forEach(node => {
        node.style.display = 'block';
    });
}

function showDepartmentView() {
    // Group by departments
    const departments = {};
    document.querySelectorAll('.org-node').forEach(node => {
        const dept = node.getAttribute('data-department');
        if (!departments[dept]) {
            departments[dept] = [];
        }
        departments[dept].push(node);
    });
    
    // Reorganize display by departments
    let html = '';
    Object.keys(departments).forEach(dept => {
        html += '<div class="department-group">' +
                '<h5 class="text-primary text-center mb-3">' + dept.toUpperCase() + '</h5>' +
                '<div class="org-level">';
        departments[dept].forEach(node => {
            html += node.outerHTML;
        });
        html += '</div></div>';
    });
    
    document.getElementById('orgChart').innerHTML = html;
    
    // Re-add click handlers
    document.querySelectorAll('.org-node').forEach(node => {
        node.addEventListener('click', function() {
            showEmployeeDetails(this);
        });
    });
}

function showCompactView() {
    // Compact view with smaller nodes
    document.querySelectorAll('.org-node').forEach(node => {
        node.classList.add('compact');
    });
}

function filterDepartment() {
    const department = document.getElementById('departmentFilter').value;
    
    if (department === '') {
        document.querySelectorAll('.org-node').forEach(node => {
            node.style.display = 'block';
        });
    } else {
        document.querySelectorAll('.org-node').forEach(node => {
            if (node.getAttribute('data-department') === department) {
                node.style.display = 'block';
            } else {
                node.style.display = 'none';
            }
        });
    }
    
    updateStats();
}

function searchEmployee() {
    const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
    
    if (searchTerm === '') {
        document.querySelectorAll('.org-node').forEach(node => {
            node.style.display = 'block';
            node.classList.remove('highlighted');
        });
    } else {
        document.querySelectorAll('.org-node').forEach(node => {
            const name = node.getAttribute('data-name');
            const position = node.getAttribute('data-position');
            
            if (name.includes(searchTerm) || position.includes(searchTerm)) {
                node.style.display = 'block';
                node.classList.add('highlighted');
            } else {
                node.style.display = 'none';
                node.classList.remove('highlighted');
            }
        });
    }
}

function showEmployeeDetails(node) {
    const employeeId = node.getAttribute('data-employee-id');
    const employeeData = {
        name: node.querySelector('.employee-name').textContent,
        title: node.querySelector('.employee-title').textContent,
        department: node.querySelector('.employee-department').textContent
    };
    
    // Navigate to employee profile page if ID is available
    if (employeeId) {
        window.location.href = `/app/hr/employees/${employeeId}`;
    } else {
        // Fallback: show employee details in notification or modal
        if (window.notify) {
            window.notify(
                `Employee: ${employeeData.name}\nTitle: ${employeeData.title}\nDepartment: ${employeeData.department}`,
                'info'
            );
        } else {
            alert('Employee: ' + employeeData.name + '\nTitle: ' + employeeData.title + '\nDepartment: ' + employeeData.department);
        }
    }
}
</script>
