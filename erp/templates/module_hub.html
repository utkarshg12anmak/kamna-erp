<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ERP Module Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --primary: #3C83F6; --bg: #f5f6f8; --card-shadow: 0 8px 24px rgba(0,0,0,.08); }
    body { background: var(--bg); }
    .module-card { background:#fff; border-radius:14px; box-shadow:var(--card-shadow); padding:20px; }
    .btn-primary { background-color: var(--primary); border-color: var(--primary); }
    .btn-primary:hover { filter: brightness(0.95); background-color: var(--primary); border-color: var(--primary); }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 m-0">Module Hub</h1>
      <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">Logout</button>
    </div>
    <div id="grid" class="row g-3">
      <!-- Cards injected by HTML below; visibility controlled by JS -->
      <div class="col-12 col-sm-6 col-lg-4" data-group="Catalog">
        <div class="module-card h-100">
          <div class="d-flex align-items-center mb-2"><span class="me-2">üì¶</span><h2 class="h5 m-0">Catalog</h2></div>
          <p class="text-muted mb-3">Manage brands, products and categories.</p>
          <a href="/app/catalog" class="btn btn-primary">Open</a>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4" data-group="Warehousing">
        <div class="module-card h-100">
          <div class="d-flex align-items-center mb-2"><span class="me-2">üè¨</span><h2 class="h5 m-0">Warehousing</h2></div>
          <p class="text-muted mb-3">Track stock and locations.</p>
          <a href="/app/warehousing" class="btn btn-primary">Open</a>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4" data-group="Manufacturing">
        <div class="module-card h-100">
          <div class="d-flex align-items-center mb-2"><span class="me-2">üè≠</span><h2 class="h5 m-0">Manufacturing</h2></div>
          <p class="text-muted mb-3">Plan and execute production.</p>
          <a href="/app/manufacturing" class="btn btn-primary">Open</a>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4" data-group="Sales">
        <div class="module-card h-100">
          <div class="d-flex align-items-center mb-2"><span class="me-2">üßæ</span><h2 class="h5 m-0">Sales</h2></div>
          <p class="text-muted mb-3">Quotes, orders and invoices.</p>
          <a href="/app/sales" class="btn btn-primary">Open</a>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4" data-group="Finance">
        <div class="module-card h-100">
          <div class="d-flex align-items-center mb-2"><span class="me-2">üí∞</span><h2 class="h5 m-0">Finance</h2></div>
          <p class="text-muted mb-3">Payables and receivables.</p>
          <a href="/app/finance" class="btn btn-primary">Open</a>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4" data-group="Admin">
        <div class="module-card h-100">
          <div class="d-flex align-items-center mb-2"><span class="me-2">üõ†Ô∏è</span><h2 class="h5 m-0">Admin</h2></div>
          <p class="text-muted mb-3">System configuration and users.</p>
          <a href="/admin/" class="btn btn-primary">Open</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    function showOnlyAllowed(groups) {
      const cards = document.querySelectorAll('[data-group]');
      cards.forEach(card => {
        const group = card.getAttribute('data-group');
        if (group === 'Admin') {
          card.style.display = groups.includes('Admin') ? '' : 'none';
        } else {
          card.style.display = groups.includes(group) ? '' : 'none';
        }
      });
    }

    async function fetchMe(token) {
      const res = await fetch('/api/auth/me/', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.status === 401) {
        window.location = '/';
        return null;
      }
      if (!res.ok) throw new Error('Failed to load user');
      return res.json();
    }

    (async function init() {
      const token = localStorage.getItem('accessToken');
      if (!token) { window.location = '/'; return; }
      try {
        const me = await fetchMe(token);
        if (!me) return;
        showOnlyAllowed(me.groups || []);
      } catch (e) {
        window.location = '/';
      }
    })();

    document.getElementById('logoutBtn').addEventListener('click', function () {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      window.location = '/';
    });
  </script>
</body>
</html>
