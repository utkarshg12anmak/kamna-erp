<div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <a href="/app/inventory/stn" class="btn btn-outline-secondary btn-sm">← Back to List</a>
      <h2 class="h5 mb-0" id="stnTitle">STN Details</h2>
    </div>
    <div class="d-flex gap-2" id="actionButtons">
      <!-- Actions will be populated based on STN status -->
    </div>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Error State -->
  <div id="errorState" class="d-none">
    <div class="alert alert-danger">
      <h6>Error Loading STN</h6>
      <p class="mb-0">The STN could not be loaded. Please try again or contact support.</p>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="d-none">
    <div class="row g-3">
      <!-- Left Column: STN Details -->
      <div class="col-md-8">
        <!-- Basic Information -->
        <div class="card-like mb-3">
          <h6 class="mb-3">Basic Information</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label text-muted">STN Code</label>
              <div class="fw-semibold" id="stnCode">—</div>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">Status</label>
              <div id="stnStatus">—</div>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">From Warehouse</label>
              <div id="fromWarehouse">—</div>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">To Warehouse</label>
              <div id="toWarehouse">—</div>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">Reference</label>
              <div id="reference">—</div>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">Remarks</label>
              <div id="remarks">—</div>
            </div>
          </div>
        </div>

        <!-- Transfer Items -->
        <div class="card-like mb-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Transfer Items</h6>
            <div class="small text-muted" id="itemsSummary">—</div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Item Name</th>
                  <th class="text-end">Quantity</th>
                  <th>UOM</th>
                </tr>
              </thead>
              <tbody id="itemsTableBody">
                <tr>
                  <td colspan="4" class="text-center text-muted">Loading items...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Status History -->
        <div class="card-like">
          <h6 class="mb-3">Status History</h6>
          <div id="statusHistory">
            <div class="text-center text-muted">Loading history...</div>
          </div>
        </div>
      </div>

      <!-- Right Column: Quick Info & Actions -->
      <div class="col-md-4">
        <!-- Quick Info -->
        <div class="card-like mb-3">
          <h6 class="mb-3">Quick Info</h6>
          <div class="small">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Total Items:</span>
              <span class="fw-semibold" id="totalItems">—</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Total Quantity:</span>
              <span class="fw-semibold" id="totalQty">—</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Created By:</span>
              <span id="createdBy">—</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Created:</span>
              <span id="createdAt">—</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-muted">Updated:</span>
              <span id="updatedAt">—</span>
            </div>
          </div>
        </div>

        <!-- Warehouse Details -->
        <div class="card-like mb-3">
          <h6 class="mb-3">Warehouse Details</h6>
          
          <div class="mb-3">
            <div class="small text-muted mb-1">Source Warehouse</div>
            <div class="border rounded p-2">
              <div class="fw-semibold" id="fromWarehouseDetail">—</div>
              <div class="small text-muted" id="fromWarehouseAddress">—</div>
            </div>
          </div>
          
          <div class="mb-3">
            <div class="small text-muted mb-1">Destination Warehouse</div>
            <div class="border rounded p-2">
              <div class="fw-semibold" id="toWarehouseDetail">—</div>
              <div class="small text-muted" id="toWarehouseAddress">—</div>
            </div>
          </div>
        </div>

        <!-- Actions Card -->
        <div class="card-like" id="actionsCard">
          <h6 class="mb-3">Actions</h6>
          <div class="d-grid gap-2" id="actionsList">
            <!-- Actions will be populated based on status -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Action Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="confirmModalMessage">Are you sure you want to perform this action?</p>
        <div id="confirmWarnings" class="alert alert-warning" style="display:none;">
          <ul id="warningsList" class="mb-0"></ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirm</button>
      </div>
    </div>
  </div>
</div>

<script>
let stnData = null;
let currentAction = null;

// Authentication helper functions
function token() {
    const t = localStorage.getItem('accessToken');
    if (!t) {
        window.location = '/';
    }
    return t;
}

async function apiFetch(url, options = {}) {
    const headers = Object.assign({
        'Authorization': `Bearer ${token()}`,
        'Content-Type': 'application/json'
    }, options.headers || {});
    
    const res = await fetch(url, { ...options, headers });
    
    if (res.status === 401) {
        window.location = '/';
        throw new Error('Unauthorized');
    }
    
    return res;
}

document.addEventListener('DOMContentLoaded', function() {
    const stnId = getStnIdFromUrl();
    if (stnId) {
        loadSTNData(stnId);
    } else {
        showError('Invalid STN ID');
    }
});

function getStnIdFromUrl() {
    const pathParts = window.location.pathname.split('/');
    const stnIndex = pathParts.indexOf('stn');
    return stnIndex !== -1 && pathParts[stnIndex + 1] ? parseInt(pathParts[stnIndex + 1]) : null;
}

async function loadSTNData(stnId) {
    try {
        const response = await apiFetch(`/api/inventory/stns/${stnId}/`);
        const data = await response.json();
        
        if (response.ok) {
            stnData = data;
            renderSTNData();
            loadStatusHistory(stnId);
        } else {
            throw new Error(data.detail || 'Failed to load STN');
        }
        
    } catch (error) {
        console.error('Error loading STN data:', error);
        showError();
    }
}

function renderSTNData() {
    document.getElementById('loadingState').classList.add('d-none');
    document.getElementById('mainContent').classList.remove('d-none');
    
    // Basic information
    document.getElementById('stnTitle').textContent = `STN ${stnData.stn_code}`;
    document.getElementById('stnCode').textContent = stnData.stn_code;
    
    const statusBadge = document.getElementById('stnStatus');
    const statusClass = {
        'PENDING': 'warning',
        'CONFIRMED': 'success',
        'CANCELLED': 'danger'
    }[stnData.status] || 'secondary';
    statusBadge.innerHTML = `<span class="badge bg-${statusClass}">${stnData.status}</span>`;
    
    document.getElementById('fromWarehouse').textContent = stnData.from_warehouse_name || '—';
    document.getElementById('toWarehouse').textContent = stnData.to_warehouse_name || '—';
    document.getElementById('reference').textContent = stnData.reference || '—';
    document.getElementById('remarks').textContent = stnData.remarks || '—';
    
    // Quick info
    document.getElementById('totalItems').textContent = stnData.total_unique_skus || 0;
    document.getElementById('totalQty').textContent = (stnData.total_qty || 0).toLocaleString();
    document.getElementById('createdBy').textContent = stnData.created_by_username || '—';
    document.getElementById('createdAt').textContent = formatDate(stnData.created_at);
    document.getElementById('updatedAt').textContent = formatDate(stnData.updated_at);
    
    // Items summary
    document.getElementById('itemsSummary').textContent = 
        `${stnData.total_unique_skus || 0} items, ${(stnData.total_qty || 0).toLocaleString()} total quantity`;
    
    // Warehouse details
    document.getElementById('fromWarehouseDetail').textContent = stnData.from_warehouse_name || '—';
    document.getElementById('toWarehouseDetail').textContent = stnData.to_warehouse_name || '—';
    
    // Render items table
    renderItemsTable();
    
    // Setup action buttons
    setupActionButtons();
}

function renderItemsTable() {
    const tbody = document.getElementById('itemsTableBody');
    
    if (!stnData.details || stnData.details.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No items found</td></tr>';
        return;
    }
    
    tbody.innerHTML = stnData.details.map(item => `
        <tr>
            <td><code>${item.sku_code}</code></td>
            <td>${item.sku_name || '—'}</td>
            <td class="text-end">${(item.qty || 0).toLocaleString()}</td>
            <td>${item.sku_uom || '—'}</td>
        </tr>
    `).join('');
}

function setupActionButtons() {
    const actionButtons = document.getElementById('actionButtons');
    const actionsList = document.getElementById('actionsList');
    
    actionButtons.innerHTML = '';
    actionsList.innerHTML = '';
    
    if (stnData.status === 'PENDING') {
        // Header action buttons
        actionButtons.innerHTML = `
            <button class="btn btn-success btn-sm" onclick="confirmSTN()">Confirm STN</button>
            <button class="btn btn-outline-danger btn-sm" onclick="cancelSTN()">Cancel STN</button>
        `;
        
        // Side panel actions
        actionsList.innerHTML = `
            <button class="btn btn-success" onclick="confirmSTN()">
                <i class="fas fa-check me-1"></i> Confirm Transfer
            </button>
            <button class="btn btn-outline-danger" onclick="cancelSTN()">
                <i class="fas fa-times me-1"></i> Cancel STN
            </button>
            <button class="btn btn-outline-secondary" onclick="printSTN()">
                <i class="fas fa-print me-1"></i> Print STN
            </button>
        `;
    } else {
        // Only print action for confirmed/cancelled STNs
        actionButtons.innerHTML = `
            <button class="btn btn-outline-secondary btn-sm" onclick="printSTN()">Print</button>
        `;
        
        actionsList.innerHTML = `
            <button class="btn btn-outline-secondary" onclick="printSTN()">
                <i class="fas fa-print me-1"></i> Print STN
            </button>
        `;
    }
}

async function loadStatusHistory(stnId) {
    try {
        const response = await apiFetch(`/api/inventory/stns/${stnId}/history/`);
        const data = await response.json();
        const history = data.results || data;
        
        const historyDiv = document.getElementById('statusHistory');
        
        if (history.length === 0) {
            historyDiv.innerHTML = '<p class="text-muted mb-0">No history available</p>';
            return;
        }
        
        const historyHTML = history.map(entry => {
            const icon = getStatusIcon(entry.status);
            const date = formatDate(entry.timestamp);
            
            return `
                <div class="d-flex align-items-start mb-3">
                    <div class="flex-shrink-0 me-3">
                        <div class="status-icon">${icon}</div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">${entry.status}</div>
                        <div class="small text-muted">
                            ${entry.user ? `by ${entry.user}` : ''} • ${date}
                        </div>
                        ${entry.notes ? `<div class="small mt-1">${entry.notes}</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        historyDiv.innerHTML = `
            <div class="timeline">
                ${historyHTML}
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading status history:', error);
        document.getElementById('statusHistory').innerHTML = 
            '<p class="text-danger mb-0">Error loading history</p>';
    }
}

function getStatusIcon(status) {
    const icons = {
        'PENDING': '<i class="fas fa-clock text-warning"></i>',
        'CONFIRMED': '<i class="fas fa-check-circle text-success"></i>',
        'CANCELLED': '<i class="fas fa-times-circle text-danger"></i>'
    };
    return icons[status] || '<i class="fas fa-circle text-muted"></i>';
}

async function confirmSTN() {
    if (!stnData) return;
    
    currentAction = 'confirm';
    
    // Check for warnings first
    try {
        const response = await apiFetch(`/api/inventory/stns/${stnData.id}/confirm/`, {
            method: 'POST',
            body: JSON.stringify({ dry_run: true })
        });
        
        const result = await response.json();
        
        document.getElementById('confirmModalTitle').textContent = 'Confirm STN';
        document.getElementById('confirmModalMessage').textContent = 
            'Are you sure you want to confirm this STN? This action cannot be undone.';
        
        const warningsDiv = document.getElementById('confirmWarnings');
        const warningsList = document.getElementById('warningsList');
        
        if (result.warnings && result.warnings.length > 0) {
            warningsList.innerHTML = result.warnings.map(w => `<li>${w}</li>`).join('');
            warningsDiv.style.display = 'block';
        } else {
            warningsDiv.style.display = 'none';
        }
        
        new bootstrap.Modal(document.getElementById('confirmModal')).show();
        
    } catch (error) {
        console.error('Error checking STN confirmation:', error);
        notify('Error checking STN: ' + error.message, 'error');
    }
}

async function cancelSTN() {
    if (!stnData) return;
    
    currentAction = 'cancel';
    
    document.getElementById('confirmModalTitle').textContent = 'Cancel STN';
    document.getElementById('confirmModalMessage').textContent = 
        'Are you sure you want to cancel this STN? This action cannot be undone.';
    document.getElementById('confirmWarnings').style.display = 'none';
    
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

// Handle confirm action button
document.getElementById('confirmActionBtn').addEventListener('click', async function() {
    if (!currentAction || !stnData) return;
    
    try {
        let url, method;
        
        if (currentAction === 'confirm') {
            url = `/api/inventory/stns/${stnData.id}/confirm/`;
            method = 'POST';
        } else if (currentAction === 'cancel') {
            url = `/api/inventory/stns/${stnData.id}/soft_delete/`;
            method = 'POST';
        }
        
        const response = await apiFetch(url, {
            method: method
        });
        
        const result = await response.json();
        
        if (response.ok) {
            const actionName = currentAction === 'confirm' ? 'confirmed' : 'cancelled';
            notify(`STN ${actionName} successfully`, 'success');
            
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            
            // Reload STN data to show updated status
            setTimeout(() => {
                loadSTNData(stnData.id);
            }, 1000);
            
        } else {
            throw new Error(result.detail || `Failed to ${currentAction} STN`);
        }
        
    } catch (error) {
        console.error(`Error ${currentAction}ing STN:`, error);
        notify(`Error ${currentAction}ing STN: ` + error.message, 'error');
    }
});

function printSTN() {
    if (!stnData) return;
    
    // Create a print-friendly version
    const printWindow = window.open('', '_blank');
    const printContent = generatePrintContent();
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

function generatePrintContent() {
    const items = stnData.details || [];
    const itemsHTML = items.map(item => `
        <tr>
            <td>${item.sku_code}</td>
            <td>${item.sku_name || '—'}</td>
            <td style="text-align: right;">${(item.qty || 0).toLocaleString()}</td>
            <td>${item.sku_uom || '—'}</td>
        </tr>
    `).join('');
    
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>STN ${stnData.stn_code}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                .info-section { border: 1px solid #ddd; padding: 15px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f5f5f5; }
                .total { font-weight: bold; background-color: #f9f9f9; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Stock Transfer Note</h1>
                <h2>${stnData.stn_code}</h2>
                <p>Status: <strong>${stnData.status}</strong></p>
            </div>
            
            <div class="info-grid">
                <div class="info-section">
                    <h3>From Warehouse</h3>
                    <p><strong>${stnData.from_warehouse_name || '—'}</strong></p>
                </div>
                <div class="info-section">
                    <h3>To Warehouse</h3>
                    <p><strong>${stnData.to_warehouse_name || '—'}</strong></p>
                </div>
                <div class="info-section">
                    <h3>Reference</h3>
                    <p>${stnData.reference || '—'}</p>
                </div>
                <div class="info-section">
                    <h3>Created</h3>
                    <p>${formatDate(stnData.created_at)}</p>
                    <p>By: ${stnData.created_by_username || '—'}</p>
                </div>
            </div>
            
            ${stnData.remarks ? `<p><strong>Remarks:</strong> ${stnData.remarks}</p>` : ''}
            
            <table>
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Item Name</th>
                        <th>Quantity</th>
                        <th>UOM</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsHTML}
                    <tr class="total">
                        <td colspan="2"><strong>Total</strong></td>
                        <td style="text-align: right;"><strong>${(stnData.total_qty || 0).toLocaleString()}</strong></td>
                        <td><strong>${stnData.total_unique_skus || 0} items</strong></td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 50px;">
                <p>Generated on: ${new Date().toLocaleString()}</p>
            </div>
        </body>
        </html>
    `;
}

function showError() {
    document.getElementById('loadingState').classList.add('d-none');
    document.getElementById('errorState').classList.remove('d-none');
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function notify(message, type = 'info') {
    // Simple notification implementation
    const alertClass = type === 'success' ? 'alert-success' : 
                       type === 'error' ? 'alert-danger' : 
                       type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const div = document.createElement('div');
    div.className = `alert ${alertClass} position-fixed`;
    div.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${message}</span>
            <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(div);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        if (div.parentElement) {
            div.remove();
        }
    }, 4000);
}
</script>

<style>
.status-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: #f3f4f6;
}

.timeline {
    position: relative;
    padding-left: 20px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 11px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e5e7eb;
}

.timeline .d-flex {
    position: relative;
}

.timeline .status-icon {
    background: white;
    border: 2px solid #e5e7eb;
    position: relative;
    z-index: 1;
}
</style>
