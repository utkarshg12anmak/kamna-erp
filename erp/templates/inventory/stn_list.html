<div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 m-0">Stock Transfer Notes</h2>
    <div class="d-flex gap-2">
      <a href="/app/inventory/stn/new" class="btn btn-primary btn-sm">+ Create STN</a>
      <button class="btn btn-outline-secondary btn-sm" onclick="exportData()">Export</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="card-like mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label" for="searchInput">Search</label>
        <input type="search" id="searchInput" class="form-control" placeholder="Search STN code, warehouse...">
      </div>
      <div class="col-md-2">
        <label class="form-label" for="statusFilter">Status</label>
        <select id="statusFilter" class="form-select">
          <option value="">All Status</option>
          <option value="PENDING">Pending</option>
          <option value="CONFIRMED">Confirmed</option>
          <option value="CANCELLED">Cancelled</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label" for="fromWarehouseFilter">From Warehouse</label>
        <select id="fromWarehouseFilter" class="form-select">
          <option value="">All Warehouses</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label" for="toWarehouseFilter">To Warehouse</label>
        <select id="toWarehouseFilter" class="form-select">
          <option value="">All Warehouses</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label" for="pageSize">Per Page</label>
        <select id="pageSize" class="form-select">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="col-md-1">
        <button class="btn btn-outline-primary w-100" onclick="applyFilters()">Filter</button>
      </div>
    </div>
  </div>

  <!-- Status Buttons -->
  <div class="mb-3">
    <div class="btn-group btn-group-sm" role="group">
      <button type="button" class="btn btn-outline-secondary active" data-status="">All</button>
      <button type="button" class="btn btn-outline-warning" data-status="PENDING">Pending</button>
      <button type="button" class="btn btn-outline-success" data-status="CONFIRMED">Confirmed</button>
      <button type="button" class="btn btn-outline-danger" data-status="CANCELLED">Cancelled</button>
    </div>
  </div>

  <!-- STN Table -->
  <div class="card-like">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th><a href="#" data-sort="stn_code">STN Code</a></th>
            <th><a href="#" data-sort="from_warehouse__name">From Warehouse</a></th>
            <th><a href="#" data-sort="to_warehouse__name">To Warehouse</a></th>
            <th><a href="#" data-sort="status">Status</a></th>
            <th class="text-end"><a href="#" data-sort="total_qty">Total Qty</a></th>
            <th class="text-end"><a href="#" data-sort="total_unique_skus">SKUs</a></th>
            <th><a href="#" data-sort="created_by__username">Created By</a></th>
            <th><a href="#" data-sort="created_at">Created</a></th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="stnTableBody">
          <tr>
            <td colspan="9" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-3 px-3 pb-3">
      <div id="pageInfo" class="small text-muted"></div>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item">
            <button class="page-link" id="prevPage" onclick="changePage(-1)">Previous</button>
          </li>
          <li class="page-item">
            <button class="page-link" id="nextPage" onclick="changePage(1)">Next</button>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="text-center py-4" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="text-center py-5" style="display:none;">
    <div class="text-muted">
      <i class="fas fa-clipboard-list fa-2x mb-3"></i>
      <p>No STNs found matching your criteria</p>
      <button class="btn btn-outline-primary btn-sm" onclick="clearFilters()">Clear Filters</button>
      <a href="/app/inventory/stn/new" class="btn btn-primary btn-sm">Create First STN</a>
    </div>
  </div>
</div>

<!-- Confirm Action Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm STN</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to confirm this STN? This action cannot be undone.</p>
        <div id="confirmWarnings" class="alert alert-warning" style="display:none;">
          <strong>Warning:</strong> Some items may have insufficient stock.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmSTNBtn">Confirm STN</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentPage = 1;
let pageSize = 25;
let currentSort = { field: '-created_at', direction: 'desc' };
let currentFilters = {};
let selectedSTNId = null;

// Authentication helper functions
function token() {
    const t = localStorage.getItem('accessToken');
    if (!t) {
        window.location = '/';
    }
    return t;
}

async function apiFetch(url, options = {}) {
    const headers = Object.assign({
        'Authorization': `Bearer ${token()}`,
        'Content-Type': 'application/json'
    }, options.headers || {});
    
    const res = await fetch(url, { ...options, headers });
    
    if (res.status === 401) {
        window.location = '/';
        throw new Error('Unauthorized');
    }
    
    return res;
}

document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    loadSTNData();
    setupEventListeners();
});

function setupEventListeners() {
    // Search input with debounce
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1;
            applyFilters();
        }, 500);
    });

    // Filter selects
    ['statusFilter', 'fromWarehouseFilter', 'toWarehouseFilter', 'pageSize'].forEach(id => {
        document.getElementById(id).addEventListener('change', function() {
            currentPage = 1;
            if (id === 'pageSize') {
                pageSize = parseInt(this.value);
            }
            applyFilters();
        });
    });

    // Status buttons
    document.querySelectorAll('[data-status]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-status]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentPage = 1;
            const status = this.dataset.status;
            document.getElementById('statusFilter').value = status;
            applyFilters();
        });
    });

    // Sorting
    document.querySelectorAll('[data-sort]').forEach(th => {
        th.addEventListener('click', function(e) {
            e.preventDefault();
            const field = this.dataset.sort;
            
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            currentPage = 1;
            loadSTNData();
        });
    });
}

async function initializeFilters() {
    try {
        // Load warehouses for filter dropdowns
        const response = await apiFetch('/api/warehousing/warehouses/?status=ACTIVE');
        const data = await response.json();
        const warehouses = data.results || [];
        
        const fromSelect = document.getElementById('fromWarehouseFilter');
        const toSelect = document.getElementById('toWarehouseFilter');
        
        warehouses.forEach(wh => {
            const option1 = new Option(`${wh.code} - ${wh.name}`, wh.id);
            const option2 = new Option(`${wh.code} - ${wh.name}`, wh.id);
            fromSelect.appendChild(option1);
            toSelect.appendChild(option2);
        });
        
    } catch (error) {
        console.error('Error loading warehouses:', error);
    }
}

function applyFilters() {
    currentFilters = {
        search: document.getElementById('searchInput').value.trim(),
        status: document.getElementById('statusFilter').value,
        from_warehouse: document.getElementById('fromWarehouseFilter').value,
        to_warehouse: document.getElementById('toWarehouseFilter').value,
    };
    
    loadSTNData();
}

async function loadSTNData() {
    try {
        document.getElementById('loadingState').style.display = 'block';
        
        // Build query params
        const params = new URLSearchParams({
            page: currentPage,
            page_size: pageSize,
            ordering: currentSort.direction === 'desc' ? '-' + currentSort.field : currentSort.field
        });
        
        // Add filters
        Object.entries(currentFilters).forEach(([key, value]) => {
            if (value) {
                if (key === 'search') {
                    params.append('search', value);
                } else {
                    params.append(key, value);
                }
            }
        });
        
        const response = await apiFetch(`/api/inventory/stns/?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            renderSTNTable(data.results || []);
            updatePagination(data);
            
            if ((data.results || []).length === 0 && Object.values(currentFilters).some(v => v)) {
                document.getElementById('emptyState').style.display = 'block';
            } else {
                document.getElementById('emptyState').style.display = 'none';
            }
        } else {
            throw new Error(data.detail || 'Failed to load STNs');
        }
        
    } catch (error) {
        console.error('Error loading STN data:', error);
        notify('Error loading STN data: ' + error.message, 'error');
        document.getElementById('stnTableBody').innerHTML = 
            '<tr><td colspan="9" class="text-center text-danger">Error loading data</td></tr>';
    } finally {
        document.getElementById('loadingState').style.display = 'none';
    }
}

function renderSTNTable(stns) {
    const tbody = document.getElementById('stnTableBody');
    
    if (stns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No STNs found</td></tr>';
        return;
    }
    
    tbody.innerHTML = stns.map(stn => {
        const statusClass = {
            'PENDING': 'warning',
            'CONFIRMED': 'success',
            'CANCELLED': 'danger'
        }[stn.status] || 'secondary';
        
        return `
            <tr>
                <td><code>${stn.stn_code}</code></td>
                <td>${stn.from_warehouse_name || '—'}</td>
                <td>${stn.to_warehouse_name || '—'}</td>
                <td><span class="badge bg-${statusClass}">${stn.status}</span></td>
                <td class="text-end">${(stn.total_qty || 0).toLocaleString()}</td>
                <td class="text-end">${stn.total_unique_skus || 0}</td>
                <td>${stn.created_by_username || '—'}</td>
                <td><small>${formatDate(stn.created_at)}</small></td>
                <td class="text-end">
                    <div class="btn-group btn-group-sm">
                        <a href="/app/inventory/stn/${stn.id}" class="btn btn-outline-primary">View</a>
                        ${stn.status === 'PENDING' ? `
                            <button class="btn btn-outline-success" onclick="confirmSTN(${stn.id})">Confirm</button>
                            <button class="btn btn-outline-danger" onclick="cancelSTN(${stn.id})">Cancel</button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function updatePagination(data) {
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    const totalPages = Math.ceil(data.count / pageSize);
    pageInfo.textContent = `Page ${currentPage} of ${totalPages} • ${data.count} total`;
    
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;
}

function changePage(direction) {
    currentPage += direction;
    loadSTNData();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('fromWarehouseFilter').value = '';
    document.getElementById('toWarehouseFilter').value = '';
    
    // Reset status buttons
    document.querySelectorAll('[data-status]').forEach(btn => btn.classList.remove('active'));
    document.querySelector('[data-status=""]').classList.add('active');
    
    currentFilters = {};
    currentPage = 1;
    loadSTNData();
}

async function confirmSTN(stnId) {
    try {
        selectedSTNId = stnId;
        
        // Check for any warnings first
        const response = await fetch(`/api/inventory/stns/${stnId}/confirm/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ dry_run: true })
        });
        
        const result = await response.json();
        
        if (result.warnings && result.warnings.length > 0) {
            document.getElementById('confirmWarnings').style.display = 'block';
            document.getElementById('confirmWarnings').innerHTML = 
                '<strong>Warning:</strong> ' + result.warnings.join('<br>');
        } else {
            document.getElementById('confirmWarnings').style.display = 'none';
        }
        
        new bootstrap.Modal(document.getElementById('confirmModal')).show();
        
    } catch (error) {
        console.error('Error checking STN:', error);
        notify('Error checking STN: ' + error.message, 'error');
    }
}

document.getElementById('confirmSTNBtn').addEventListener('click', async function() {
    if (!selectedSTNId) return;
    
    try {
        const response = await apiFetch(`/api/inventory/stns/${selectedSTNId}/confirm/`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            notify('STN confirmed successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            loadSTNData(); // Refresh the table
        } else {
            throw new Error(result.detail || 'Failed to confirm STN');
        }
        
    } catch (error) {
        console.error('Error confirming STN:', error);
        notify('Error confirming STN: ' + error.message, 'error');
    }
});

async function cancelSTN(stnId) {
    if (!confirm('Are you sure you want to cancel this STN? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await apiFetch(`/api/inventory/stns/${stnId}/soft_delete/`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            notify('STN cancelled successfully', 'success');
            loadSTNData(); // Refresh the table
        } else {
            throw new Error(result.detail || 'Failed to cancel STN');
        }
        
    } catch (error) {
        console.error('Error cancelling STN:', error);
        notify('Error cancelling STN: ' + error.message, 'error');
    }
}

function exportData() {
    // Simple CSV export
    const params = new URLSearchParams(currentFilters);
    params.append('format', 'csv');
    params.append('page_size', '1000'); // Get more records for export
    
    window.open(`/api/inventory/stns/?${params}`);
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function notify(message, type = 'info') {
    // Simple notification implementation
    const alertClass = type === 'success' ? 'alert-success' : 
                       type === 'error' ? 'alert-danger' : 
                       type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const div = document.createElement('div');
    div.className = `alert ${alertClass} position-fixed`;
    div.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${message}</span>
            <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(div);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        if (div.parentElement) {
            div.remove();
        }
    }, 4000);
}
</script>
