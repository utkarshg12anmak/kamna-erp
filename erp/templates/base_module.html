<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ module }} | ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --primary:#3C83F6; --text:#111827; --muted:#6B7280; --border:#E5E7EB; --panel:#F9FAFB; }
    body { background: var(--panel); color: var(--text); }
    .topbar { position: sticky; top: 0; z-index: 10; background:#fff; border-bottom:1px solid var(--border); }
    .sidebar { width:240px; border-right:1px solid var(--border); background:#fff; }
    .content { flex: 1; padding: 24px; }
    .nav-link { color: var(--text); border-left:3px solid transparent; border-radius: 0; }
    .nav-link.active, .nav-link:focus, .nav-link:hover { border-left-color: var(--primary); background:#F3F4F6; }
    .nav-link.active { font-weight: 600; }
    .card-like { background:#fff; border:1px solid var(--border); border-radius:12px; padding: 20px; }
    /* KPI strip helpers: keep cards on one line with horizontal scroll */
    .kpi-strip { display:flex; flex-wrap: nowrap; gap: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .kpi-card { flex: 0 0 auto; min-width: 180px; }
    .btn-primary { background-color: var(--primary); border-color: var(--primary); }
    .toast-area { position: fixed; top: 12px; right: 12px; z-index: 2000; display:flex; flex-direction:column; gap:8px; }
  </style>
</head>
<body>
  <div class="topbar py-2">
    <div class="container-fluid d-flex justify-content-between align-items-center position-relative">
      <div class="d-flex align-items-center gap-2">
        <a href="/app" class="text-decoration-none">← Back to Modules</a>
        <span class="fw-semibold">{{ module }}</span>
      </div>
      {% if warehouse %}
      <div class="position-absolute top-50 start-50 translate-middle text-center" style="pointer-events:none;">
        <div class="small text-muted lh-1">Warehouse</div>
        <div class="fw-semibold lh-1">{{ warehouse.code }} — {{ warehouse.name }}</div>
      </div>
      {% endif %}
      <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">Logout</button>
    </div>
  </div>

  <div class="d-flex" style="min-height: calc(100vh - 48px);">
    <aside class="sidebar p-3">
      <nav class="nav flex-column" id="sideNav">
        {% for item in menu %}
          <a class="nav-link {% if item.active %}active{% endif %}" href="{{ item.href }}">{{ item.label }}</a>
        {% endfor %}
      </nav>
    </aside>
    <main class="content">
      <div id="accessDenied" class="card-like text-center p-5" style="display:none;">
        <h2 class="h5 mb-2">You do not have access to this module</h2>
        <a class="btn btn-primary" href="/app">Back to Modules</a>
      </div>
      <div id="moduleContent" class="card-like">
        {% include content_template %}
      </div>
    </main>
  </div>

  <!-- Notification area -->
  <div id="toastArea" class="toast-area"></div>

  <script>
    // Simple notifications
    window.notify = function(msg, type='info', timeout=3000){
      const area = document.getElementById('toastArea');
      const div = document.createElement('div');
      const cls = type==='success' ? 'alert-success' : type==='error' ? 'alert-danger' : type==='warning' ? 'alert-warning' : 'alert-info';
      div.className = `alert ${cls} shadow-sm mb-0`;
      div.innerHTML = `<div class="d-flex justify-content-between align-items-start gap-3">`+
        `<div>${msg}</div>`+
        `<button type="button" class="btn-close" aria-label="Close"></button>`+
      `</div>`;
      div.querySelector('.btn-close').addEventListener('click', ()=> div.remove());
      area.appendChild(div);
      if(timeout>0){ setTimeout(()=> div.remove(), timeout); }
      return div;
    }

    async function checkAccess(moduleName) {
      // CV Hub (Customer & Vendor Hub) has no permission restrictions - accessible to all users
      if (moduleName === 'Customer & Vendor Hub') {
        return true;
      }
      
      const token = localStorage.getItem('accessToken');
      if (!token) { window.location = '/'; return false; }
      const res = await fetch('/api/auth/me/', { headers: { 'Authorization': `Bearer ${token}` } });
      if (res.status === 401) { window.location = '/'; return false; }
      const me = await res.json();
      const groups = me.groups || [];
      const perms = me.perms || {};
      let allowed = false;
      if (moduleName === 'Admin') {
        allowed = groups.includes('Admin');
      } else {
        allowed = groups.includes(moduleName);
      }
      if (!allowed) {
        document.getElementById('moduleContent').style.display = 'none';
        document.getElementById('accessDenied').style.display = 'block';
        return false;
      }
      return true;
    }

    (async function initShell(){
      // Highlight active by path
      const path = window.location.pathname;
      document.querySelectorAll('#sideNav .nav-link').forEach(a => {
        if (a.getAttribute('href') === path) a.classList.add('active');
        else a.classList.remove('active');
      });
      await checkAccess('{{ module|safe }}');
    })();

    document.getElementById('logoutBtn').addEventListener('click', function () {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      window.location = '/';
    });
  </script>
  <!-- Bootstrap JS for modals, dropdowns, etc. -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
