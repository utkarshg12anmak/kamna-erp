<div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 m-0">Movements — {{ warehouse.code }} {{ warehouse.name }}</h2>
    <a class="btn btn-outline-secondary btn-sm" href="/app/warehousing/w/{{ warehouse.code }}">Back to Overview</a>
  </div>

  <div class="card-like mb-3">
    <form id="filters" class="row g-2 align-items-end">
      <div class="col-sm-6 col-md-3">
        <label class="form-label small">Search</label>
        <input class="form-control form-control-sm" type="text" id="q" placeholder="SKU, item name, memo, ref" />
      </div>
      <div class="col-sm-6 col-md-3">
        <label class="form-label small">Type</label>
        <select class="form-select form-select-sm" id="type">
          <option value="">Any</option>
          <option value="ADJ_REQ_DAMAGE">Adj Req Damage</option>
          <option value="ADJ_REQ_LOST">Adj Req Lost</option>
          <option value="ADJ_REQ_EXCESS">Adj Req Excess</option>
          <option value="ADJ_APPROVE_DAMAGE">Adj Approve Damage</option>
          <option value="ADJ_DECLINE_DAMAGE">Adj Decline Damage</option>
          <option value="ADJ_APPROVE_LOST">Adj Approve Lost</option>
          <option value="ADJ_DECLINE_LOST">Adj Decline Lost</option>
          <option value="ADJ_APPROVE_EXCESS">Adj Approve Excess</option>
          <option value="ADJ_DECLINE_EXCESS">Adj Decline Excess</option>
          <option value="TRANSFER">Transfer</option>
        </select>
      </div>
      <div class="col-sm-6 col-md-2">
        <label class="form-label small">From</label>
        <input class="form-control form-control-sm" type="date" id="date_from" />
      </div>
      <div class="col-sm-6 col-md-2">
        <label class="form-label small">To</label>
        <input class="form-control form-control-sm" type="date" id="date_to" />
      </div>
      <div class="col-sm-6 col-md-2">
        <button class="btn btn-primary btn-sm w-100" type="submit">Apply</button>
      </div>
    </form>
  </div>

  <div class="card-like">
    <div class="table-responsive">
      <table class="table table-sm align-middle table-striped">
        <thead>
          <tr>
            <th style="width:44px;"></th>
            <th>When</th>
            <th>Item</th>
            <th>From</th>
            <th>To</th>
            <th class="text-end">Qty</th>
            <th>Type</th>
            <th>Initiator</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between align-items-center px-2 py-2">
      <div class="small" id="pageInfo"></div>
      <div class="d-flex gap-1">
        <button class="btn btn-outline-secondary btn-sm" id="prevBtn">Prev</button>
        <button class="btn btn-outline-secondary btn-sm" id="nextBtn">Next</button>
      </div>
    </div>
  </div>
</div>

<div id="whCtx" data-wh-id="{{ warehouse.id }}" style="display:none;"></div>

<script>
  function token(){ const t = localStorage.getItem('accessToken'); if(!t){ window.location='/'; } return t; }
  async function apiFetch(url){
    const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token()}` }});
    if(res.status===401){ window.location='/'; throw new Error('Unauthorized'); }
    const ct = res.headers.get('content-type')||'';
    if(!ct.includes('application/json')){ return { results: [] }; }
    try{ return await res.json(); } catch(e){ return { results: [] }; }
  }
  function fmtDate(v){ if(!v) return ''; return new Date(v).toLocaleString(); }
  function fmtLoc(x){ if(!x) return ''; return x.location_name || x.location_code || x.location_subtype || x.location; }
  function fromLoc(x){ return (Number(x.qty_delta) < 0) ? fmtLoc(x) : ''; }
  function toLoc(x){ return (Number(x.qty_delta) > 0) ? fmtLoc(x) : ''; }
  function movementSpan(before, after){
    if(before==='' && after==='') return '';
    const b = before!=='' && before!=null ? Number(before) : null;
    const a = after!=='' && after!=null ? Number(after) : null;
    const bTxt = b==null ? '' : b.toLocaleString(undefined,{maximumFractionDigits:3});
    const aTxt = a==null ? '' : a.toLocaleString(undefined,{maximumFractionDigits:3});
    if(bTxt==='' && aTxt==='') return '';
    return `${bTxt} → ${aTxt}`;
  }
  function imgTag(url){ if(!url) return `<div class="rounded bg-light" style="width:36px;height:36px;"></div>`; return `<img src="${url}" alt="" class="rounded" style="width:36px;height:36px;object-fit:cover;"/>`; }

  let page = 1; const pageSize = 25; let hasNext = false; let hasPrev = false; let totalCount = null;
  async function load(){
    const whId = Number(document.getElementById('whCtx').dataset.whId || '0');
    const params = new URLSearchParams();
    const q = document.getElementById('q').value.trim();
    const type = document.getElementById('type').value;
    const d1 = document.getElementById('date_from').value;
    const d2 = document.getElementById('date_to').value;
    if(q) params.set('search', q);
    if(type) params.set('type', type);
    if(d1) params.set('date_from', d1);
    if(d2) params.set('date_to', d2);
    params.set('ordering', '-ts');
    params.set('page', page);
    params.set('page_size', pageSize);

    const url = `/api/warehousing/warehouses/${whId}/movements/?` + params.toString();
    const data = await apiFetch(url);
    const raw = data && (data.results || Array.isArray(data) && data) || [];
    hasNext = Boolean(data.next);
    hasPrev = Boolean(data.previous);
    totalCount = data.count ?? null;

    // Pair complementary rows (opposite qty signs) sharing same ref and item
    const paired = [];
    const used = new Set();
    const keyOf = (r) => `${r.ref_model||''}|${r.ref_id||''}|${r.item}`;
    const buckets = new Map();
    raw.forEach((r, idx)=>{
      const k = keyOf(r);
      if(!buckets.has(k)) buckets.set(k, []);
      buckets.get(k).push({ r, idx });
    });

    raw.forEach((r, idx)=>{
      if(used.has(idx)) return;
      const k = keyOf(r);
      const bucket = (buckets.get(k)||[]).map(x=>x.idx).filter(i=>!used.has(i));
      // try to find counterpart with opposite sign
      const otherIdx = bucket.find(i => i!==idx && Math.sign(Number(raw[i].qty_delta)) !== Math.sign(Number(r.qty_delta)));
      if(otherIdx !== undefined){
        const a = r; const b = raw[otherIdx];
        used.add(idx); used.add(otherIdx);
        const fromRow = Number(a.qty_delta) < 0 ? a : b;
        const toRow = Number(a.qty_delta) > 0 ? a : b;
        paired.push({
          ts: fromRow.ts || toRow.ts,
          item_sku: fromRow.item_sku || toRow.item_sku,
          item_name: fromRow.item_name || toRow.item_name,
          img: fromRow.item_image_url || toRow.item_image_url || '',
          from_loc: fmtLoc(fromRow),
          from_span: movementSpan(fromRow.location_qty_before, fromRow.location_qty_after),
          to_loc: fmtLoc(toRow),
          to_span: movementSpan(toRow.location_qty_before, toRow.location_qty_after),
          qty: Math.abs(Number(fromRow.qty_delta || toRow.qty_delta || 0)),
          movement_type: fromRow.movement_type || toRow.movement_type,
          user: fromRow.user || toRow.user || 'System'
        });
        return;
      }
      // Fallback single-sided
      used.add(idx);
      const isOut = Number(r.qty_delta) < 0;
      paired.push({
        ts: r.ts,
        item_sku: r.item_sku,
        item_name: r.item_name,
        img: r.item_image_url || '',
        from_loc: isOut ? fmtLoc(r) : '',
        from_span: isOut ? movementSpan(r.location_qty_before, r.location_qty_after) : '',
        to_loc: !isOut ? fmtLoc(r) : '',
        to_span: !isOut ? movementSpan(r.location_qty_before, r.location_qty_after) : '',
        qty: Math.abs(Number(r.qty_delta)),
        movement_type: r.movement_type,
        user: r.user || 'System'
      });
    });

    document.getElementById('rows').innerHTML = paired.length ? paired.map(x => `
      <tr>
        <td>${imgTag(x.img)}</td>
        <td>${fmtDate(x.ts)}</td>
        <td>${x.item_sku} — ${x.item_name}</td>
        <td>${x.from_loc ? (x.from_loc + ' (' + x.from_span + ')') : ''}</td>
        <td>${x.to_loc ? (x.to_loc + ' (' + x.to_span + ')') : ''}</td>
        <td class='text-end'>${(x.qty||0).toLocaleString(undefined,{maximumFractionDigits:3})}</td>
        <td>${x.movement_type}</td>
        <td>${x.user || 'System'}</td>
      </tr>`).join('') : `<tr><td colspan="8" class="text-center text-muted">No movements</td></tr>`;

    const info = totalCount!=null ? `Page ${page}` + (totalCount? ` • ${totalCount} records` : '') : `Page ${page}`;
    document.getElementById('pageInfo').textContent = info;
    document.getElementById('prevBtn').disabled = !hasPrev && page<=1;
    document.getElementById('nextBtn').disabled = !hasNext;
  }

  document.getElementById('filters').addEventListener('submit', e => { e.preventDefault(); page = 1; load(); });
  document.getElementById('prevBtn').addEventListener('click', () => { if(page>1){ page--; load(); } });
  document.getElementById('nextBtn').addEventListener('click', () => { if(hasNext){ page++; load(); } });
  document.addEventListener('DOMContentLoaded', load);
</script>
