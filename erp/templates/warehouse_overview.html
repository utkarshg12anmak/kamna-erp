<div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 m-0">Warehouse Overview</h2>
    <div class="d-flex gap-2">
      <a class="btn btn-primary btn-sm" href="/app/warehousing/w/{{ warehouse.code }}/adjust">Adjust Inventory</a>
      <a class="btn btn-outline-primary btn-sm" href="/app/warehousing/w/{{ warehouse.code }}/movements">Movements</a>
      <a class="btn btn-outline-secondary btn-sm" href="/app/warehousing/w/{{ warehouse.code }}/approvals">Approvals</a>
      <a class="btn btn-outline-secondary btn-sm" href="/app/warehousing/approvals">All Approvals</a>
      <a class="btn btn-outline-secondary btn-sm" href="/app/warehousing/config/locations?warehouse={{ warehouse.id }}">View Locations</a>
      <a class="btn btn-outline-secondary btn-sm" href="/app/warehousing/config">Configuration</a>
    </div>
  </div>
  <div class="row g-3">
    <div class="col-sm-6 col-lg-3">
      <div class="card-like text-center">
        <div class="small text-muted">Total Qty</div>
        <div class="display-6" id="kpiTotalQty">-</div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card-like text-center">
        <div class="small text-muted">Items</div>
        <div class="display-6" id="kpiItems">-</div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card-like text-center">
        <div class="small text-muted">Locations With Stock</div>
        <div class="display-6" id="kpiLocs">-</div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card-like text-center">
        <div class="small text-muted">Movements Today</div>
        <div class="display-6" id="kpiMoves">-</div>
      </div>
    </div>
    <div class="col-12">
      <div class="card-like">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="small text-muted">Active Locations Total Qty</div>
            <div class="h4 m-0" id="activeTotalQty">-</div>
          </div>
          <button class="btn btn-outline-primary btn-sm" id="viewActiveBreakdown">View Breakdown</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead><tr><th>Location Subtype</th><th class="text-end">Qty</th><th class="text-end"></th></tr></thead>
            <tbody id="activeSubtypeRows"><tr><td colspan="3" class="text-center text-muted">Loading…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="mt-3">
    <div class="card-like">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="h6 m-0">Recent Activity</h3>
        <a class="btn btn-sm btn-outline-secondary" href="/app/warehousing/w/{{ warehouse.code }}/movements">View All</a>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead><tr><th>When</th><th>Item</th><th>Location</th><th class="text-end">Qty</th><th>Type</th></tr></thead>
          <tbody id="recentRows"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal for SKU breakdown -->
<div class="modal fade" id="activeBreakdownModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Active Locations — SKU Breakdown</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>SKU</th><th>Name</th><th class="text-end">Qty</th></tr></thead>
            <tbody id="activeSkuRows"></tbody>
            <tfoot><tr><th colspan="2" class="text-end">Grand Total</th><th class="text-end" id="activeGrandTotal">0</th></tr></tfoot>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Context carrier remains -->
<div id="whCtx" data-wh-id="{{ warehouse.id }}" style="display:none;"></div>

<script>
  function token(){ const t = localStorage.getItem('accessToken'); if(!t){ window.location='/'; } return t; }
  async function apiFetch(url){ const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token()}` }}); if(res.status===401){ window.location='/'; throw new Error('Unauthorized'); } return res.json(); }
  function fmtDate(v){ if(!v) return ''; return new Date(v).toLocaleString(); }
  function fmtLoc(x){
    if(!x) return '';
    const name = x.location_name || '';
    const code = x.location_code || '';
    const subtype = x.location_subtype || '';
    return name || code || subtype || (x.location || '');
  }
  function fmtSubtypeLabel(s){ return s || '—'; }
  async function loadActiveTotals(){
    const whId = Number(document.getElementById('whCtx').dataset.whId || '0');
    const data = await apiFetch(`/api/warehousing/warehouses/${whId}/active_stock_summary/`);
    document.getElementById('activeTotalQty').textContent = data.total_qty ?? 0;
    // Populate subtype pivot with a per-row View button
    const tbody = document.getElementById('activeSubtypeRows');
    const rows = (data.per_subtype||[]).sort((a,b)=> String(a.subtype).localeCompare(String(b.subtype)));
    if(!rows.length){ tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No stock</td></tr>`; return data; }
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td>${fmtSubtypeLabel(r.subtype)}</td>
        <td class='text-end'>${r.qty}</td>
        <td class='text-end'>
          <button type="button" class="btn btn-sm btn-outline-primary view-subtype" data-subtype="${String(r.subtype||'')}">View</button>
        </td>
      </tr>`).join('');
    // Bind click to open filtered breakdown
    tbody.querySelectorAll('.view-subtype').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const subtype = btn.getAttribute('data-subtype');
        try{
          const whId = Number(document.getElementById('whCtx').dataset.whId || '0');
          const data = await apiFetch(`/api/warehousing/warehouses/${whId}/active_stock_summary/?subtype=${encodeURIComponent(subtype)}`);
          const items = (data.items||[]).sort((a,b)=> String(a.item_sku).localeCompare(String(b.item_sku)));
          document.getElementById('activeSkuRows').innerHTML = items.length ? items.map(r => `<tr><td>${r.item_sku}</td><td>${r.item_name||''}</td><td class='text-end'>${r.qty}</td></tr>`).join('') : `<tr><td colspan="3" class="text-center text-muted">No stock</td></tr>`;
          document.getElementById('activeGrandTotal').textContent = data.grand_total ?? 0;
          const el = document.getElementById('activeBreakdownModal');
          const m = window.bootstrap ? window.bootstrap.Modal.getOrCreateInstance(el) : null;
          if(m){ m.show(); } else { el.style.display='block'; el.classList.add('show'); }
        }catch(e){ /* handled by apiFetch */ }
      });
    });
    return data;
  }
  async function init(){
    const whId = Number(document.getElementById('whCtx').dataset.whId || '0');
    const k = await apiFetch(`/api/warehousing/warehouses/${whId}/kpis/`);
    document.getElementById('kpiTotalQty').textContent = (k.total_qty ?? 0);
    document.getElementById('kpiItems').textContent = (k.total_items ?? 0);
    document.getElementById('kpiLocs').textContent = (k.locations_with_stock ?? 0);
    document.getElementById('kpiMoves').textContent = (k.movements_today ?? 0);
    // Load recent activity
    const r = await apiFetch(`/api/warehousing/warehouses/${whId}/recent_activity/`);
    const list = Array.isArray(r) ? r : (r.results || []);
    document.getElementById('recentRows').innerHTML = list.map(x => `<tr><td>${fmtDate(x.ts)}</td><td>${x.item_sku} — ${x.item_name}</td><td>${fmtLoc(x)}</td><td class='text-end'>${x.qty_delta}</td><td>${x.movement_type}</td></tr>`).join('');
    // Active totals
    await loadActiveTotals();
  }
  document.addEventListener('DOMContentLoaded', init);

  // Breakdown button
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('viewActiveBreakdown');
    if(!btn) return;
    btn.addEventListener('click', async () => {
      try{
        const data = await loadActiveTotals();
        const rows = (data.items||[]).sort((a,b)=> String(a.item_sku).localeCompare(String(b.item_sku)));
        document.getElementById('activeSkuRows').innerHTML = rows.length ? rows.map(r => `<tr><td>${r.item_sku}</td><td>${r.item_name||''}</td><td class='text-end'>${r.qty}</td></tr>`).join('') : `<tr><td colspan="3" class="text-center text-muted">No stock</td></tr>`;
        document.getElementById('activeGrandTotal').textContent = data.grand_total ?? 0;
        // Show modal (Bootstrap 5, closes on outside click by default when JS bundle loaded)
        const el = document.getElementById('activeBreakdownModal');
        const m = window.bootstrap ? window.bootstrap.Modal.getOrCreateInstance(el) : null;
        if(m){ m.show(); } else { el.style.display='block'; el.classList.add('show'); }
      }catch(e){ /* rely on global toasts if present */ }
    });
  });
</script>
