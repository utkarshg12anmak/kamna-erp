<div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 m-0">Adjustment Approvals — {{ warehouse.code }} {{ warehouse.name }}</h2>
    <a class="btn btn-outline-secondary btn-sm" href="/app/warehousing/w/{{ warehouse.code }}">Back to Overview</a>
  </div>
  <div class="card-like mb-3">
    <form id="filters" class="row g-2 align-items-end">
      <div class="col-sm-6 col-md-3">
        <label class="form-label small">Search</label>
        <input class="form-control form-control-sm" id="q" placeholder="Number, SKU, item name" />
      </div>
      <div class="col-sm-6 col-md-2">
        <button class="btn btn-primary btn-sm w-100" type="submit">Apply</button>
      </div>
    </form>
  </div>
  <div class="card-like">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Number</th>
            <th>Item</th>
            <th class="text-end">Qty</th>
            <th>Type</th>
            <th>Status</th>
            <th>Requested By</th>
            <th>When</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between align-items-center px-2 py-2">
      <div class="small" id="pageInfo"></div>
      <div class="d-flex gap-1">
        <button class="btn btn-outline-secondary btn-sm" id="prevBtn">Prev</button>
        <button class="btn btn-outline-secondary btn-sm" id="nextBtn">Next</button>
      </div>
    </div>
  </div>
</div>

<div id="whCtx" data-wh-id="{{ warehouse.id }}" style="display:none;"></div>

<script>
  function token(){ const t = localStorage.getItem('accessToken'); if(!t){ window.location='/'; } return t; }
  async function api(url, opts={}){
    opts.headers = Object.assign({ 'Authorization': `Bearer ${token()}`, 'Content-Type': 'application/json' }, opts.headers||{});
    const res = await fetch(url, opts);
    let body = null; try{ body = await res.json(); }catch(e){ body = null; }
    if(!res.ok){
      let msg = 'Request failed';
      if(body){
        if(typeof body === 'string') msg = body;
        else if(body.detail) msg = body.detail;
        else if(Array.isArray(body)) msg = body.join(', ');
        else if(body.non_field_errors) msg = body.non_field_errors.join(', ');
        else msg = JSON.stringify(body);
      }
      notify(msg, 'error');
      throw new Error(msg);
    }
    return body;
  }
  function fmtDate(v){ return v? new Date(v).toLocaleString() : ''; }

  let page = 1; const pageSize = 25; let lastCount = 0; let canDelete = false;
  async function load(){
    const whId = Number(document.getElementById('whCtx').dataset.whId||'0');
    const p = new URLSearchParams({ warehouse: String(whId), ordering: '-requested_at', page: String(page), page_size: String(pageSize) });
    const q = document.getElementById('q').value.trim(); if(q) p.set('search', q);
    const data = await api('/api/warehousing/adjustment-requests/?' + p.toString());
    const results = data.results || data;
    lastCount = results.length;
    document.getElementById('rows').innerHTML = results.map(r => `
      <tr>
        <td>${r.number}</td>
        <td>${r.item_sku || r.item} — ${r.item_name||''}</td>
        <td class='text-end'>${r.qty}</td>
        <td>${r.type}</td>
        <td>${r.status}</td>
        <td>${r.requested_by||''}</td>
        <td>${fmtDate(r.requested_at)}</td>
        <td>
          ${canDelete && r.status==='REQUESTED' ? `<button class="btn btn-outline-danger btn-sm" onclick="delReq(${r.id}, '${r.number.replace(/'/g, "\'")}')">Delete</button>` : '<span class="text-muted small">—</span>'}
        </td>
      </tr>`).join('');
    document.getElementById('pageInfo').textContent = `Page ${page}`;
    document.getElementById('prevBtn').disabled = (page<=1);
    document.getElementById('nextBtn').disabled = (lastCount < pageSize);
  }

  async function delReq(id, number){
    const c1 = confirm(`Delete adjustment ${number}? This will revert inventory.`);
    if(!c1) return;
    const c2 = confirm('Are you sure? This cannot be undone.');
    if(!c2) return;
    try{
      await api(`/api/warehousing/adjustment-requests/${id}/`, { method:'DELETE' });
      notify('Deleted and reverted', 'success');
      await load();
    }catch(e){ /* errors already surfaced */ }
  }

  async function loadPerm(){
    try{ const r = await api('/api/warehousing/adjustment-permissions/'); canDelete = !!r.can_delete; }
    catch(e){ canDelete=false; }
  }

  document.getElementById('filters').addEventListener('submit', (e)=>{ e.preventDefault(); page=1; load(); });
  document.getElementById('prevBtn').addEventListener('click', ()=>{ if(page>1){ page--; load(); }});
  document.getElementById('nextBtn').addEventListener('click', ()=>{ if(lastCount===pageSize){ page++; load(); }});
  document.addEventListener('DOMContentLoaded', async ()=>{ await loadPerm(); await load(); });
</script>
