<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <a href="/app/cv_hub/entries" class="btn btn-outline-secondary btn-sm">‚Üê Back to List</a>
      <h2 class="h5 mb-0">Edit Entry</h2>
    </div>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-secondary btn-sm" id="cancelBtn">Cancel</button>
      <button type="button" class="btn btn-primary btn-sm" id="saveBtn">Save Changes</button>
    </div>
  </div>

  <div id="loadingState" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div id="mainContent" class="d-none">
    <!-- Nav tabs -->
    <ul class="nav nav-tabs mb-3" id="formTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">Summary</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="gst-tab" data-bs-toggle="tab" data-bs-target="#gst" type="button" role="tab">GST Registrations</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="addresses-tab" data-bs-toggle="tab" data-bs-target="#addresses" type="button" role="tab">Addresses</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button" role="tab">Contacts</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">History</button>
      </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content" id="formTabContent">
      <!-- Summary Tab -->
      <div class="tab-pane fade show active" id="summary" role="tabpanel">
        <form id="summaryForm">
          <div class="card-like">
            <h6 class="mb-3">Basic Information</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="legal_name" class="form-label">Legal Name *</label>
                <input type="text" class="form-control" id="legal_name" required>
              </div>
              <div class="col-md-6">
                <label for="trade_name" class="form-label">Trade Name</label>
                <input type="text" class="form-control" id="trade_name">
              </div>
              <div class="col-md-6">
                <label for="constitution" class="form-label">Constitution</label>
                <select class="form-select" id="constitution">
                  <option value="INDIVIDUAL">Individual</option>
                  <option value="PROPRIETORSHIP">Proprietorship</option>
                  <option value="PARTNERSHIP">Partnership</option>
                  <option value="PVTLTD">Private Limited</option>
                  <option value="LLP">LLP</option>
                  <option value="TRUST">Trust</option>
                  <option value="GOVT">Government</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status">
                  <option value="ACTIVE">Active</option>
                  <option value="INACTIVE">Inactive</option>
                  <option value="BLACKLISTED">Blacklisted</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Roles *</label>
                <div class="d-flex gap-3 mt-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_customer">
                    <label class="form-check-label" for="is_customer">Customer</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_supplier">
                    <label class="form-check-label" for="is_supplier">Supplier</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_vendor">
                    <label class="form-check-label" for="is_vendor">Vendor</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="is_logistics">
                    <label class="form-check-label" for="is_logistics">Logistics</label>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Usage *</label>
                <div class="d-flex gap-3 mt-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="for_sales">
                    <label class="form-check-label" for="for_sales">For Sales</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="for_purchase">
                    <label class="form-check-label" for="for_purchase">For Purchase</label>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <label for="website" class="form-label">Website</label>
                <input type="url" class="form-control" id="website">
              </div>
              <div class="col-md-6">
                <label for="tags" class="form-label">Tags</label>
                <input type="text" class="form-control" id="tags" placeholder="Comma separated tags">
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- GST Tab -->
      <div class="tab-pane fade" id="gst" role="tabpanel">
        <div class="card-like">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">GST Registrations</h6>
            <button type="button" class="btn btn-outline-primary btn-sm" id="addGstBtn">Add Registration</button>
          </div>
          <div id="gstList">
            <p class="text-muted">Loading GST registrations...</p>
          </div>
        </div>
      </div>

      <!-- Addresses Tab -->
      <div class="tab-pane fade" id="addresses" role="tabpanel">
        <div class="card-like">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Addresses</h6>
            <button type="button" class="btn btn-outline-primary btn-sm" id="addAddressBtn">Add Address</button>
          </div>
          <div id="addressList">
            <p class="text-muted">Loading addresses...</p>
          </div>
        </div>
      </div>

      <!-- Contacts Tab -->
      <div class="tab-pane fade" id="contacts" role="tabpanel">
        <div class="card-like">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Contacts</h6>
            <button type="button" class="btn btn-outline-primary btn-sm" id="addContactBtn">Add Contact</button>
          </div>
          <div id="contactList">
            <p class="text-muted">Loading contacts...</p>
          </div>
        </div>
      </div>

      <!-- History Tab -->
      <div class="tab-pane fade" id="history" role="tabpanel">
        <div class="card-like">
          <h6 class="mb-3">Change History</h6>
          <p class="text-muted">History tracking will be available in a future update.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Same modals as in the view template -->
<!-- Add GST Registration Modal -->
<div class="modal fade" id="addGSTModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add GST Registration</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addGSTForm">
          <div class="mb-3">
            <label for="gst_taxpayer_type" class="form-label">Taxpayer Type</label>
            <select class="form-select" id="gst_taxpayer_type" required>
              <option value="REGULAR">Regular</option>
              <option value="COMPOSITION">Composition</option>
              <option value="CASUAL">Casual</option>
              <option value="UNREGISTERED">Unregistered</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="gst_gstin" class="form-label">GSTIN</label>
            <input type="text" class="form-control" id="gst_gstin" maxlength="15">
          </div>
          <div class="mb-3">
            <label for="gst_legal_name" class="form-label">Legal Name of Business</label>
            <input type="text" class="form-control" id="gst_legal_name" required>
          </div>
          <div class="mb-3">
            <label for="gst_trade_name" class="form-label">Trade Name</label>
            <input type="text" class="form-control" id="gst_trade_name">
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="gst_is_primary">
            <label class="form-check-label" for="gst_is_primary">Set as Primary</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveGSTRegistration()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addAddressForm">
          <div class="mb-3">
            <label for="addr_type" class="form-label">Type</label>
            <select class="form-select" id="addr_type" required>
              <option value="BILLING">Billing</option>
              <option value="SHIPPING">Shipping</option>
              <option value="BOTH">Both</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="addr_line1" class="form-label">Address Line 1</label>
            <input type="text" class="form-control" id="addr_line1" required>
          </div>
          <div class="mb-3">
            <label for="addr_line2" class="form-label">Address Line 2</label>
            <input type="text" class="form-control" id="addr_line2">
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="addr_state" class="form-label">State</label>
              <select class="form-select" id="addr_state" required></select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="addr_city" class="form-label">City</label>
              <select class="form-select" id="addr_city" required></select>
            </div>
          </div>
          <div class="mb-3">
            <label for="addr_pincode" class="form-label">Pincode</label>
            <input type="text" class="form-control" id="addr_pincode" required>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="addr_is_default_billing">
                <label class="form-check-label" for="addr_is_default_billing">Default Billing</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="addr_is_default_shipping">
                <label class="form-check-label" for="addr_is_default_shipping">Default Shipping</label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveAddress()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Contact</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addContactForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="contact_first_name" class="form-label">First Name *</label>
              <input type="text" class="form-control" id="contact_first_name" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="contact_last_name" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="contact_last_name">
            </div>
          </div>
          <div class="mb-3">
            <label for="contact_designation" class="form-label">Designation</label>
            <select class="form-select" id="contact_designation">
              <option value="CEO">Chief Executive Officer</option>
              <option value="CFO">Chief Financial Officer</option>
              <option value="CTO">Chief Technology Officer</option>
              <option value="MANAGER">Manager</option>
              <option value="ASSISTANT_MANAGER">Assistant Manager</option>
              <option value="EXECUTIVE">Executive</option>
              <option value="SENIOR_EXECUTIVE">Senior Executive</option>
              <option value="ACCOUNTANT">Accountant</option>
              <option value="SALES_MANAGER">Sales Manager</option>
              <option value="PURCHASE_MANAGER">Purchase Manager</option>
              <option value="DIRECTOR">Director</option>
              <option value="PARTNER">Partner</option>
              <option value="PROPRIETOR">Proprietor</option>
              <option value="OTHER" selected>Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="contact_phone" class="form-label">Phone * (8-10 digits)</label>
            <input type="tel" class="form-control" id="contact_phone" required maxlength="10" pattern="[0-9]{8,10}">
            <div class="form-text">Enter 8-10 digits only</div>
          </div>
          </div>
          <div class="mb-3">
            <label for="contact_email" class="form-label">Email</label>
            <input type="email" class="form-control" id="contact_email">
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="contact_is_primary">
            <label class="form-check-label" for="contact_is_primary">Set as Primary</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveContact()">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
let entryId = null;
let entryData = null;

document.addEventListener('DOMContentLoaded', function() {
    // Get entry ID from URL
    const pathParts = window.location.pathname.split('/');
    entryId = pathParts[pathParts.length - 2]; // /edit is the last part
    
    if (entryId && !isNaN(entryId)) {
        loadEntryData();
    } else {
        alert('Invalid entry ID');
        window.location.href = '/app/cv_hub/entries';
    }
    
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('saveBtn').addEventListener('click', saveEntry);
    document.getElementById('cancelBtn').addEventListener('click', function() {
        if (confirm('Discard changes and go back?')) {
            window.location.href = `/app/cv_hub/entries/${entryId}`;
        }
    });
    
    // Add event listeners for the "Add" buttons
    document.getElementById('addGstBtn').addEventListener('click', function() {
        openAddGSTModal();
    });
    
    document.getElementById('addAddressBtn').addEventListener('click', function() {
        openAddAddressModal();
    });
    
    document.getElementById('addContactBtn').addEventListener('click', function() {
        openAddContactModal();
    });
}

async function loadEntryData() {
    try {
        const response = await fetch(`/api/cv_hub/entries/${entryId}/`);
        if (!response.ok) {
            throw new Error('Failed to load entry');
        }
        
        entryData = await response.json();
        populateForm();
        
    } catch (error) {
        console.error('Error loading entry:', error);
        alert('Error loading entry data');
        window.location.href = '/app/cv_hub/entries';
    }
}

function populateForm() {
    document.getElementById('loadingState').classList.add('d-none');
    document.getElementById('mainContent').classList.remove('d-none');
    
    // Populate summary form
    document.getElementById('legal_name').value = entryData.legal_name;
    document.getElementById('trade_name').value = entryData.trade_name || '';
    document.getElementById('constitution').value = entryData.constitution;
    document.getElementById('status').value = entryData.status;
    document.getElementById('website').value = entryData.website || '';
    document.getElementById('tags').value = entryData.tags || '';
    
    // Populate checkboxes
    document.getElementById('is_customer').checked = entryData.is_customer;
    document.getElementById('is_supplier').checked = entryData.is_supplier;
    document.getElementById('is_vendor').checked = entryData.is_vendor;
    document.getElementById('is_logistics').checked = entryData.is_logistics;
    document.getElementById('for_sales').checked = entryData.for_sales;
    document.getElementById('for_purchase').checked = entryData.for_purchase;
    
    // Load other tabs when they're clicked
    document.getElementById('gst-tab').addEventListener('click', loadGSTTab);
    document.getElementById('addresses-tab').addEventListener('click', loadAddressesTab);
    document.getElementById('contacts-tab').addEventListener('click', loadContactsTab);
}

function loadGSTTab() {
    const container = document.getElementById('gstList');
    
    if (!entryData.registrations || entryData.registrations.length === 0) {
        container.innerHTML = '<p class="text-muted">No GST registrations. Click "Add Registration" to create one.</p>';
        return;
    }
    
    container.innerHTML = entryData.registrations.map(reg => `
        <div class="border rounded p-3 mb-2">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small">GSTIN</label>
                    <input type="text" class="form-control" value="${reg.gstin || ''}" maxlength="15">
                </div>
                <div class="col-md-4">
                    <label class="form-label small">Taxpayer Type</label>
                    <select class="form-select">
                        <option value="REGULAR" ${reg.taxpayer_type === 'REGULAR' ? 'selected' : ''}>Regular</option>
                        <option value="COMPOSITION" ${reg.taxpayer_type === 'COMPOSITION' ? 'selected' : ''}>Composition</option>
                        <option value="CASUAL" ${reg.taxpayer_type === 'CASUAL' ? 'selected' : ''}>Casual</option>
                        <option value="UNREGISTERED" ${reg.taxpayer_type === 'UNREGISTERED' ? 'selected' : ''}>Unregistered</option>
                        <option value="OTHER" ${reg.taxpayer_type === 'OTHER' ? 'selected' : ''}>Other</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <div class="form-check me-3">
                        <input class="form-check-input" type="checkbox" ${reg.is_primary ? 'checked' : ''}>
                        <label class="form-check-label">Primary</label>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm">Remove</button>
                </div>
                <div class="col-12">
                    <label class="form-label small">Legal Name of Business</label>
                    <input type="text" class="form-control" value="${reg.legal_name_of_business}">
                </div>
            </div>
        </div>
    `).join('');
}

function loadAddressesTab() {
    const container = document.getElementById('addressList');
    
    if (!entryData.addresses || entryData.addresses.length === 0) {
        container.innerHTML = '<p class="text-muted">No addresses. Click "Add Address" to create one.</p>';
        return;
    }
    
    container.innerHTML = entryData.addresses.map(addr => `
        <div class="border rounded p-3 mb-2">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small">Type</label>
                    <select class="form-select">
                        <option value="REGISTERED" ${addr.type === 'REGISTERED' ? 'selected' : ''}>Registered Office</option>
                        <option value="BILLING" ${addr.type === 'BILLING' ? 'selected' : ''}>Billing</option>
                        <option value="SHIPPING" ${addr.type === 'SHIPPING' ? 'selected' : ''}>Shipping</option>
                        <option value="PLANT" ${addr.type === 'PLANT' ? 'selected' : ''}>Plant/Factory</option>
                        <option value="OTHER" ${addr.type === 'OTHER' ? 'selected' : ''}>Other</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">State</label>
                    <input type="text" class="form-control" value="${addr.state_name}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">City</label>
                    <input type="text" class="form-control" value="${addr.city_name}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Pincode</label>
                    <input type="text" class="form-control" value="${addr.pincode}">
                </div>
                <div class="col-md-6">
                    <label class="form-label small">Address Line 1</label>
                    <input type="text" class="form-control" value="${addr.line1}">
                </div>
                <div class="col-md-6">
                    <label class="form-label small">Address Line 2</label>
                    <input type="text" class="form-control" value="${addr.line2 || ''}">
                </div>
                <div class="col-12">
                    <div class="d-flex gap-3 align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" ${addr.is_default_billing ? 'checked' : ''}>
                            <label class="form-check-label">Default Billing</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" ${addr.is_default_shipping ? 'checked' : ''}>
                            <label class="form-check-label">Default Shipping</label>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm ms-auto">Remove</button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function loadContactsTab() {
    const container = document.getElementById('contactList');
    
    if (!entryData.contacts || entryData.contacts.length === 0) {
        container.innerHTML = '<p class="text-muted">No contacts. Click "Add Contact" to create one.</p>';
        return;
    }
    
    container.innerHTML = entryData.contacts.map(contact => `
        <div class="border rounded p-3 mb-2">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small">First Name</label>
                    <input type="text" class="form-control" value="${contact.first_name || ''}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Last Name</label>
                    <input type="text" class="form-control" value="${contact.last_name || ''}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Designation</label>
                    <select class="form-select">
                        <option value="CEO" ${contact.designation === 'CEO' ? 'selected' : ''}>CEO</option>
                        <option value="CFO" ${contact.designation === 'CFO' ? 'selected' : ''}>CFO</option>
                        <option value="CTO" ${contact.designation === 'CTO' ? 'selected' : ''}>CTO</option>
                        <option value="MANAGER" ${contact.designation === 'MANAGER' ? 'selected' : ''}>Manager</option>
                        <option value="ASSISTANT_MANAGER" ${contact.designation === 'ASSISTANT_MANAGER' ? 'selected' : ''}>Assistant Manager</option>
                        <option value="EXECUTIVE" ${contact.designation === 'EXECUTIVE' ? 'selected' : ''}>Executive</option>
                        <option value="SENIOR_EXECUTIVE" ${contact.designation === 'SENIOR_EXECUTIVE' ? 'selected' : ''}>Senior Executive</option>
                        <option value="ACCOUNTANT" ${contact.designation === 'ACCOUNTANT' ? 'selected' : ''}>Accountant</option>
                        <option value="SALES_MANAGER" ${contact.designation === 'SALES_MANAGER' ? 'selected' : ''}>Sales Manager</option>
                        <option value="PURCHASE_MANAGER" ${contact.designation === 'PURCHASE_MANAGER' ? 'selected' : ''}>Purchase Manager</option>
                        <option value="DIRECTOR" ${contact.designation === 'DIRECTOR' ? 'selected' : ''}>Director</option>
                        <option value="PARTNER" ${contact.designation === 'PARTNER' ? 'selected' : ''}>Partner</option>
                        <option value="PROPRIETOR" ${contact.designation === 'PROPRIETOR' ? 'selected' : ''}>Proprietor</option>
                        <option value="OTHER" ${contact.designation === 'OTHER' || !contact.designation ? 'selected' : ''}>Other</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Phone</label>
                    <input type="tel" class="form-control" value="${contact.phone}" maxlength="10" pattern="[0-9]{8,10}">
                </div>
                <div class="col-md-6">
                    <label class="form-label small">Email</label>
                    <input type="email" class="form-control" value="${contact.email || ''}">
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <div class="form-check me-3">
                        <input class="form-check-input" type="checkbox" ${contact.is_primary ? 'checked' : ''}>
                        <label class="form-check-label">Primary Contact</label>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm">Remove</button>
                </div>
            </div>
        </div>
    `).join('');
}

async function saveEntry() {
    const formData = {
        legal_name: document.getElementById('legal_name').value,
        trade_name: document.getElementById('trade_name').value,
        constitution: document.getElementById('constitution').value,
        status: document.getElementById('status').value,
        website: document.getElementById('website').value,
        tags: document.getElementById('tags').value,
        is_customer: document.getElementById('is_customer').checked,
        is_supplier: document.getElementById('is_supplier').checked,
        is_vendor: document.getElementById('is_vendor').checked,
        is_logistics: document.getElementById('is_logistics').checked,
        for_sales: document.getElementById('for_sales').checked,
        for_purchase: document.getElementById('for_purchase').checked,
    };
    
    // Basic validation
    if (!formData.legal_name.trim()) {
        alert('Legal name is required');
        return;
    }
    
    if (!(formData.is_customer || formData.is_supplier || formData.is_vendor || formData.is_logistics)) {
        alert('Select at least one role');
        return;
    }
    
    if (!(formData.for_sales || formData.for_purchase)) {
        alert('Select at least one usage (For Sales / For Purchase)');
        return;
    }
    
    try {
        document.getElementById('saveBtn').disabled = true;
        
        const response = await fetch(`/api/cv_hub/entries/${entryId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(formData),
        });
        
        if (response.ok) {
            // Redirect to view page
            window.location.href = `/app/cv_hub/entries/${entryId}`;
        } else {
            const errorData = await response.json();
            console.error('Error saving entry:', errorData);
            alert('Error saving entry. Please check the form and try again.');
        }
    } catch (error) {
        console.error('Error saving entry:', error);
        alert('Error saving entry. Please try again.');
    } finally {
        document.getElementById('saveBtn').disabled = false;
    }
}

// Modal Functions (same as in view template)
function openAddGSTModal() {
    document.getElementById('gst_legal_name').value = entryData.legal_name;
    document.getElementById('gst_trade_name').value = entryData.trade_name || '';
    new bootstrap.Modal(document.getElementById('addGSTModal')).show();
}

function openAddAddressModal() {
    loadStatesForAddress();
    new bootstrap.Modal(document.getElementById('addAddressModal')).show();
}

function openAddContactModal() {
    new bootstrap.Modal(document.getElementById('addContactModal')).show();
}

async function loadStatesForAddress() {
    try {
        const response = await fetch('/api/cv_hub/states/');
        const data = await response.json();
        const states = data.results || data;
        
        const stateSelect = document.getElementById('addr_state');
        stateSelect.innerHTML = '<option value="">Select State</option>';
        states.forEach(state => {
            stateSelect.innerHTML += `<option value="${state.id}">${state.name}</option>`;
        });
        
        // Add state change listener for city cascade
        stateSelect.addEventListener('change', function() {
            loadCitiesForAddress(this.value);
        });
    } catch (error) {
        console.error('Error loading states:', error);
    }
}

async function loadCitiesForAddress(stateId) {
    if (!stateId) {
        document.getElementById('addr_city').innerHTML = '<option value="">Select City</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/cv_hub/cities/?state=${stateId}`);
        const data = await response.json();
        const cities = data.results || data;
        
        const citySelect = document.getElementById('addr_city');
        citySelect.innerHTML = '<option value="">Select City</option>';
        cities.forEach(city => {
            citySelect.innerHTML += `<option value="${city.id}">${city.name}</option>`;
        });
    } catch (error) {
        console.error('Error loading cities:', error);
    }
}

async function saveGSTRegistration() {
    const data = {
        entry: entryId,
        taxpayer_type: document.getElementById('gst_taxpayer_type').value,
        gstin: document.getElementById('gst_gstin').value,
        legal_name_of_business: document.getElementById('gst_legal_name').value,
        trade_name: document.getElementById('gst_trade_name').value,
        is_primary: document.getElementById('gst_is_primary').checked,
    };
    
    // Basic validation
    if (!data.legal_name_of_business.trim()) {
        alert('Legal name is required');
        return;
    }
    
    if (data.taxpayer_type !== 'UNREGISTERED' && data.gstin && data.gstin.length !== 15) {
        alert('GSTIN must be 15 characters for registered taxpayers');
        return;
    }
    
    try {
        const response = await fetch('/api/cv_hub/registrations/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(data),
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addGSTModal')).hide();
            // Refresh the data and reload the GST tab
            await loadEntryData();
            document.getElementById('gst-tab').click(); // Switch to GST tab to show new data
        } else {
            const errorData = await response.json();
            alert('Error saving GST registration: ' + (errorData.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving GST registration:', error);
        alert('Error saving GST registration');
    }
}

async function saveAddress() {
    const data = {
        entry: entryId,
        type: document.getElementById('addr_type').value,
        line1: document.getElementById('addr_line1').value,
        line2: document.getElementById('addr_line2').value,
        state: document.getElementById('addr_state').value,
        city: document.getElementById('addr_city').value,
        pincode: document.getElementById('addr_pincode').value,
        is_default_billing: document.getElementById('addr_is_default_billing').checked,
        is_default_shipping: document.getElementById('addr_is_default_shipping').checked,
    };
    
    // Basic validation
    if (!data.line1.trim() || !data.state || !data.city || !data.pincode.trim()) {
        alert('Please fill all required fields');
        return;
    }
    
    try {
        const response = await fetch('/api/cv_hub/addresses/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(data),
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addAddressModal')).hide();
            // Refresh the data and reload the addresses tab
            await loadEntryData();
            document.getElementById('addresses-tab').click(); // Switch to addresses tab to show new data
        } else {
            const errorData = await response.json();
            alert('Error saving address: ' + (errorData.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving address:', error);
        alert('Error saving address');
    }
}

async function saveContact() {
    const firstName = document.getElementById('contact_first_name').value.trim();
    const lastName = document.getElementById('contact_last_name').value.trim();
    const phone = document.getElementById('contact_phone').value.trim();
    
    // Basic validation
    if (!firstName) {
        alert('First name is required');
        return;
    }
    
    if (!phone) {
        alert('Phone number is required');
        return;
    }
    
    // Phone validation (8-10 digits)
    if (!/^[0-9]{8,10}$/.test(phone)) {
        alert('Phone number must be 8-10 digits');
        return;
    }
    
    const data = {
        entry: entryId,
        first_name: firstName,
        last_name: lastName,
        designation: document.getElementById('contact_designation').value,
        phone: phone,
        email: document.getElementById('contact_email').value,
        is_primary: document.getElementById('contact_is_primary').checked,
    };
    
    try {
        const response = await fetch('/api/cv_hub/contacts/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(data),
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addContactModal')).hide();
            // Refresh the data and reload the contacts tab
            await loadEntryData();
            document.getElementById('contacts-tab').click(); // Switch to contacts tab to show new data
        } else {
            const errorData = await response.json();
            alert('Error saving contact: ' + (errorData.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving contact:', error);
        alert('Error saving contact');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
