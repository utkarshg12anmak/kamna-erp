<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <a href="/app/cv_hub/entries" class="btn btn-outline-secondary btn-sm">← Back to List</a>
      <h2 class="h5 mb-0" id="entryTitle">Entry Details</h2>
    </div>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-primary btn-sm" id="editBtn">Edit</button>
      <div class="dropdown">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
          Actions
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" id="viewSummaryBtn">View Summary</a></li>
          <li><a class="dropdown-item" href="#" id="duplicateBtn">Duplicate Entry</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" id="deactivateBtn">Deactivate</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div id="loadingState" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div id="errorState" class="d-none">
    <div class="alert alert-danger">
      <h6>Error Loading Entry</h6>
      <p class="mb-0">The entry could not be loaded. Please try again or contact support.</p>
    </div>
  </div>

  <div id="mainContent" class="d-none">
    <div class="row g-3">
      <div class="col-md-8">
        <div class="card-like mb-3">
          <h6 class="mb-3">Basic Information</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small text-muted">Legal Name</label>
              <p class="mb-0" id="legalName">—</p>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted">Trade Name</label>
              <p class="mb-0" id="tradeName">—</p>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted">Constitution</label>
              <p class="mb-0" id="constitution">—</p>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted">Status</label>
              <p class="mb-0"><span id="status" class="badge">—</span></p>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted">Roles</label>
              <p class="mb-0" id="roles">—</p>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-muted">Usage</label>
              <p class="mb-0"><span id="usage" class="badge">—</span></p>
            </div>
            <div class="col-12" id="websiteContainer" style="display: none;">
              <label class="form-label small text-muted">Website</label>
              <p class="mb-0"><a id="website" href="#" target="_blank">—</a></p>
            </div>
            <div class="col-12" id="tagsContainer" style="display: none;">
              <label class="form-label small text-muted">Tags</label>
              <p class="mb-0" id="tags">—</p>
            </div>
          </div>
        </div>

        <div class="card-like mb-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">GST Registrations</h6>
            <button type="button" class="btn btn-outline-primary btn-sm" id="addGstBtn" data-bs-toggle="modal" data-bs-target="#addGSTModal">Add Registration</button>
          </div>
          <div id="gstRegistrations">
            <p class="text-muted">No GST registrations found.</p>
          </div>
        </div>

        <div class="card-like mb-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Addresses</h6>
            <button type="button" class="btn btn-outline-primary btn-sm" id="addAddressBtn" data-bs-toggle="modal" data-bs-target="#addAddressModal">Add Address</button>
          </div>
          <div id="addresses">
            <p class="text-muted">No addresses found.</p>
          </div>
        </div>

        <div class="card-like">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Contacts</h6>
            <button type="button" class="btn btn-outline-primary btn-sm" id="addContactBtn" data-bs-toggle="modal" data-bs-target="#addContactModal">Add Contact</button>
          </div>
          <div id="contacts">
            <p class="text-muted">No contacts found.</p>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card-like mb-3">
          <h6 class="mb-3">Quick Info</h6>
          <div class="small">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Primary GSTIN:</span>
              <code class="small" id="primaryGstin">—</code>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Created:</span>
              <span id="createdAt">—</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-muted">Last Updated:</span>
              <span id="updatedAt">—</span>
            </div>
          </div>
        </div>

        <div class="card-like mb-3">
          <h6 class="mb-3">Default Addresses</h6>
          <div class="small">
            <div class="mb-3">
              <label class="form-label small text-muted">Billing Address</label>
              <div id="defaultBilling" class="small">—</div>
            </div>
            <div>
              <label class="form-label small text-muted">Shipping Address</label>
              <div id="defaultShipping" class="small">—</div>
            </div>
          </div>
        </div>

        <div class="card-like">
          <h6 class="mb-3">Primary Contact</h6>
          <div id="primaryContact" class="small">
            <p class="text-muted">No primary contact set.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add GST Registration Modal -->
<div class="modal fade" id="addGSTModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add GST Registration</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addGSTForm">
          <div class="mb-3">
            <label for="gst_taxpayer_type" class="form-label">Taxpayer Type</label>
            <select class="form-select" id="gst_taxpayer_type" required>
              <option value="REGULAR">Regular</option>
              <option value="COMPOSITION">Composition</option>
              <option value="CASUAL">Casual</option>
              <option value="UNREGISTERED">Unregistered</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="gst_gstin" class="form-label">GSTIN</label>
            <input type="text" class="form-control" id="gst_gstin" maxlength="15">
          </div>
          <div class="mb-3">
            <label for="gst_legal_name" class="form-label">Legal Name of Business</label>
            <input type="text" class="form-control" id="gst_legal_name" required>
          </div>
          <div class="mb-3">
            <label for="gst_trade_name" class="form-label">Trade Name</label>
            <input type="text" class="form-control" id="gst_trade_name">
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="gst_is_primary">
            <label class="form-check-label" for="gst_is_primary">Set as Primary</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveGSTRegistration()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addAddressForm">
          <div class="mb-3">
            <label for="addr_type" class="form-label">Type</label>
            <select class="form-select" id="addr_type" required>
              <option value="BILLING">Billing</option>
              <option value="SHIPPING">Shipping</option>
              <option value="BOTH">Both</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="addr_line1" class="form-label">Address Line 1</label>
            <input type="text" class="form-control" id="addr_line1" required>
          </div>
          <div class="mb-3">
            <label for="addr_line2" class="form-label">Address Line 2</label>
            <input type="text" class="form-control" id="addr_line2">
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="addr_state" class="form-label">State</label>
              <select class="form-select" id="addr_state" required></select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="addr_city" class="form-label">City</label>
              <select class="form-select" id="addr_city" required></select>
            </div>
          </div>
          <div class="mb-3">
            <label for="addr_pincode" class="form-label">Pincode</label>
            <input type="text" class="form-control" id="addr_pincode" required>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="addr_is_default_billing">
                <label class="form-check-label" for="addr_is_default_billing">Default Billing</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="addr_is_default_shipping">
                <label class="form-check-label" for="addr_is_default_shipping">Default Shipping</label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveAddress()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Contact</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addContactForm">
          <div class="mb-3">
            <label for="contact_full_name" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="contact_full_name" required>
          </div>
          <div class="mb-3">
            <label for="contact_designation" class="form-label">Designation</label>
            <input type="text" class="form-control" id="contact_designation">
          </div>
          <div class="mb-3">
            <label for="contact_phone" class="form-label">Phone</label>
            <input type="tel" class="form-control" id="contact_phone" required>
          </div>
          <div class="mb-3">
            <label for="contact_email" class="form-label">Email</label>
            <input type="email" class="form-control" id="contact_email">
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="contact_is_primary">
            <label class="form-check-label" for="contact_is_primary">Set as Primary</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveContact()">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
let entryId = null;
let entryData = null;

document.addEventListener('DOMContentLoaded', function() {
    // Get entry ID from URL
    const pathParts = window.location.pathname.split('/');
    entryId = pathParts[pathParts.length - 1];
    
    if (entryId && !isNaN(entryId)) {
        loadEntryData();
    } else {
        showError();
    }
    
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('editBtn').addEventListener('click', function() {
        window.location.href = `/app/cv_hub/entries/${entryId}/edit`;
    });
    
    document.getElementById('viewSummaryBtn').addEventListener('click', viewSummary);
    document.getElementById('duplicateBtn').addEventListener('click', duplicateEntry);
    document.getElementById('deactivateBtn').addEventListener('click', deactivateEntry);
    
    // Add event listeners for the "Add" buttons
    document.getElementById('addGstBtn').addEventListener('click', function() {
        openAddGSTModal();
    });
    
    document.getElementById('addAddressBtn').addEventListener('click', function() {
        openAddAddressModal();
    });
    
    document.getElementById('addContactBtn').addEventListener('click', function() {
        openAddContactModal();
    });
}

async function loadEntryData() {
    try {
        const response = await fetch(`/api/cv_hub/entries/${entryId}/`);
        if (!response.ok) {
            throw new Error('Failed to load entry');
        }
        
        entryData = await response.json();
        renderEntryData();
        
    } catch (error) {
        console.error('Error loading entry:', error);
        showError();
    }
}

function renderEntryData() {
    document.getElementById('loadingState').classList.add('d-none');
    document.getElementById('mainContent').classList.remove('d-none');
    
    // Basic information
    document.getElementById('entryTitle').textContent = entryData.legal_name;
    document.getElementById('legalName').textContent = entryData.legal_name;
    document.getElementById('tradeName').textContent = entryData.trade_name || '—';
    document.getElementById('constitution').textContent = entryData.constitution;
    
    const statusBadge = document.getElementById('status');
    statusBadge.textContent = entryData.status;
    statusBadge.className = `badge bg-${entryData.status === 'ACTIVE' ? 'success' : 'warning'}`;
    
    // Roles
    const roles = [];
    if (entryData.is_customer) roles.push('Customer');
    if (entryData.is_supplier) roles.push('Supplier');
    if (entryData.is_vendor) roles.push('Vendor');
    if (entryData.is_logistics) roles.push('Logistics');
    document.getElementById('roles').textContent = roles.join(', ') || '—';
    
    // Usage
    const usageBadge = document.getElementById('usage');
    usageBadge.textContent = entryData.commerce_label;
    usageBadge.className = 'badge bg-info';
    
    // Website
    if (entryData.website) {
        document.getElementById('websiteContainer').style.display = 'block';
        const websiteLink = document.getElementById('website');
        websiteLink.href = entryData.website;
        websiteLink.textContent = entryData.website;
    }
    
    // Tags
    if (entryData.tags) {
        document.getElementById('tagsContainer').style.display = 'block';
        document.getElementById('tags').textContent = entryData.tags;
    }
    
    // Dates
    document.getElementById('createdAt').textContent = new Date(entryData.created_at).toLocaleDateString();
    document.getElementById('updatedAt').textContent = new Date(entryData.updated_at).toLocaleDateString();
    
    // Primary GSTIN
    const primaryReg = entryData.registrations.find(reg => reg.is_primary);
    document.getElementById('primaryGstin').textContent = primaryReg?.gstin || '—';
    
    // Render sections
    renderGSTRegistrations();
    renderAddresses();
    renderContacts();
    renderDefaultAddresses();
    renderPrimaryContact();
}

function renderGSTRegistrations() {
    const container = document.getElementById('gstRegistrations');
    
    if (!entryData.registrations || entryData.registrations.length === 0) {
        container.innerHTML = '<p class="text-muted">No GST registrations found.</p>';
        return;
    }
    
    container.innerHTML = entryData.registrations.map(reg => `
        <div class="border rounded p-3 mb-2 ${reg.is_primary ? 'border-primary bg-light' : ''}">
            <div class="row g-2">
                <div class="col-md-4">
                    <small class="text-muted">GSTIN</small>
                    <div><code class="small">${reg.gstin || 'Unregistered'}</code></div>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Type</small>
                    <div>${reg.taxpayer_type}</div>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Status</small>
                    <div>
                        ${reg.is_primary ? '<span class="badge bg-primary me-1">Primary</span>' : ''}
                        <span class="badge bg-${reg.status === 'ACTIVE' ? 'success' : 'warning'}">${reg.status}</span>
                    </div>
                </div>
                <div class="col-12">
                    <small class="text-muted">Business Name</small>
                    <div>${reg.legal_name_of_business}</div>
                </div>
            </div>
        </div>
    `).join('');
}

function renderAddresses() {
    const container = document.getElementById('addresses');
    
    if (!entryData.addresses || entryData.addresses.length === 0) {
        container.innerHTML = '<p class="text-muted">No addresses found.</p>';
        return;
    }
    
    container.innerHTML = entryData.addresses.map(addr => `
        <div class="border rounded p-3 mb-2">
            <div class="row g-2">
                <div class="col-md-3">
                    <small class="text-muted">Type</small>
                    <div>${addr.type}</div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Location</small>
                    <div>${addr.city_name}, ${addr.state_name}</div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Pincode</small>
                    <div>${addr.pincode}</div>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Defaults</small>
                    <div>
                        ${addr.is_default_billing ? '<span class="badge bg-primary me-1">Billing</span>' : ''}
                        ${addr.is_default_shipping ? '<span class="badge bg-secondary">Shipping</span>' : ''}
                    </div>
                </div>
                <div class="col-12">
                    <small class="text-muted">Address</small>
                    <div>${addr.line1}${addr.line2 ? ', ' + addr.line2 : ''}</div>
                </div>
            </div>
        </div>
    `).join('');
}

function renderContacts() {
    const container = document.getElementById('contacts');
    
    if (!entryData.contacts || entryData.contacts.length === 0) {
        container.innerHTML = '<p class="text-muted">No contacts found.</p>';
        return;
    }
    
    container.innerHTML = entryData.contacts.map(contact => `
        <div class="border rounded p-3 mb-2 ${contact.is_primary ? 'border-primary bg-light' : ''}">
            <div class="row g-2">
                <div class="col-md-4">
                    <small class="text-muted">Name</small>
                    <div><strong>${contact.full_name}</strong></div>
                    ${contact.designation ? `<small class="text-muted">${contact.designation}</small>` : ''}
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Phone</small>
                    <div><a href="tel:${contact.phone}">${contact.phone}</a></div>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Email & Status</small>
                    <div>
                        ${contact.email ? `<a href="mailto:${contact.email}">${contact.email}</a><br>` : ''}
                        ${contact.is_primary ? '<span class="badge bg-primary">Primary</span>' : ''}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function renderDefaultAddresses() {
    const billing = entryData.addresses.find(addr => addr.is_default_billing);
    const shipping = entryData.addresses.find(addr => addr.is_default_shipping);
    
    document.getElementById('defaultBilling').innerHTML = billing ? 
        `${billing.line1}<br>${billing.city_name}, ${billing.state_name} ${billing.pincode}` : '—';
    
    document.getElementById('defaultShipping').innerHTML = shipping ? 
        `${shipping.line1}<br>${shipping.city_name}, ${shipping.state_name} ${shipping.pincode}` : '—';
}

function renderPrimaryContact() {
    const contact = entryData.contacts.find(c => c.is_primary);
    
    document.getElementById('primaryContact').innerHTML = contact ? `
        <div><strong>${contact.full_name}</strong></div>
        ${contact.designation ? `<div class="text-muted">${contact.designation}</div>` : ''}
        <div><a href="tel:${contact.phone}">${contact.phone}</a></div>
        ${contact.email ? `<div><a href="mailto:${contact.email}">${contact.email}</a></div>` : ''}
    ` : '<p class="text-muted">No primary contact set.</p>';
}

function showError() {
    document.getElementById('loadingState').classList.add('d-none');
    document.getElementById('errorState').classList.remove('d-none');
}

async function viewSummary() {
    try {
        const response = await fetch(`/api/cv_hub/entries/${entryId}/summary/`);
        const summary = await response.json();
        
        alert(`Summary for ${entryData.legal_name}:\n\nCommerce: ${summary.commerce_label}\nPrimary GSTIN: ${summary.primary_gstin || 'None'}\nBilling: ${summary.billing ? summary.billing.line1 : 'Not set'}\nShipping: ${summary.shipping ? summary.shipping.line1 : 'Not set'}`);
    } catch (error) {
        console.error('Error loading summary:', error);
        alert('Error loading summary');
    }
}

function duplicateEntry() {
    if (confirm('Create a duplicate of this entry?')) {
        // In a full implementation, you'd open a modal or redirect to create form with pre-filled data
        alert('Duplicate feature not yet implemented');
    }
}

async function deactivateEntry() {
    if (confirm('Are you sure you want to deactivate this entry?')) {
        try {
            const response = await fetch(`/api/cv_hub/entries/${entryId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ status: 'INACTIVE' }),
            });
            
            if (response.ok) {
                location.reload();
            } else {
                alert('Error deactivating entry');
            }
        } catch (error) {
            console.error('Error deactivating entry:', error);
            alert('Error deactivating entry');
        }
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Modal Functions
function openAddGSTModal() {
    document.getElementById('gst_legal_name').value = entryData.legal_name;
    document.getElementById('gst_trade_name').value = entryData.trade_name || '';
    new bootstrap.Modal(document.getElementById('addGSTModal')).show();
}

function openAddAddressModal() {
    loadStatesForAddress();
    new bootstrap.Modal(document.getElementById('addAddressModal')).show();
}

function openAddContactModal() {
    new bootstrap.Modal(document.getElementById('addContactModal')).show();
}

async function loadStatesForAddress() {
    try {
        const response = await fetch('/api/cv_hub/states/');
        const data = await response.json();
        const states = data.results || data;
        
        const stateSelect = document.getElementById('addr_state');
        stateSelect.innerHTML = '<option value="">Select State</option>';
        states.forEach(state => {
            stateSelect.innerHTML += `<option value="${state.id}">${state.name}</option>`;
        });
        
        // Add state change listener for city cascade
        stateSelect.addEventListener('change', function() {
            loadCitiesForAddress(this.value);
        });
    } catch (error) {
        console.error('Error loading states:', error);
    }
}

async function loadCitiesForAddress(stateId) {
    if (!stateId) {
        document.getElementById('addr_city').innerHTML = '<option value="">Select City</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/cv_hub/cities/?state=${stateId}`);
        const data = await response.json();
        const cities = data.results || data;
        
        const citySelect = document.getElementById('addr_city');
        citySelect.innerHTML = '<option value="">Select City</option>';
        cities.forEach(city => {
            citySelect.innerHTML += `<option value="${city.id}">${city.name}</option>`;
        });
    } catch (error) {
        console.error('Error loading cities:', error);
    }
}

async function saveGSTRegistration() {
    const data = {
        entry: entryId,
        taxpayer_type: document.getElementById('gst_taxpayer_type').value,
        gstin: document.getElementById('gst_gstin').value,
        legal_name_of_business: document.getElementById('gst_legal_name').value,
        trade_name: document.getElementById('gst_trade_name').value,
        is_primary: document.getElementById('gst_is_primary').checked,
    };
    
    // Basic validation
    if (!data.legal_name_of_business.trim()) {
        alert('Legal name is required');
        return;
    }
    
    if (data.taxpayer_type !== 'UNREGISTERED' && data.gstin && data.gstin.length !== 15) {
        alert('GSTIN must be 15 characters for registered taxpayers');
        return;
    }
    
    try {
        const response = await fetch('/api/cv_hub/registrations/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(data),
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addGSTModal')).hide();
            location.reload(); // Refresh to show new data
        } else {
            const errorData = await response.json();
            alert('Error saving GST registration: ' + (errorData.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving GST registration:', error);
        alert('Error saving GST registration');
    }
}

async function saveAddress() {
    const data = {
        entry: entryId,
        type: document.getElementById('addr_type').value,
        line1: document.getElementById('addr_line1').value,
        line2: document.getElementById('addr_line2').value,
        state: document.getElementById('addr_state').value,
        city: document.getElementById('addr_city').value,
        pincode: document.getElementById('addr_pincode').value,
        is_default_billing: document.getElementById('addr_is_default_billing').checked,
        is_default_shipping: document.getElementById('addr_is_default_shipping').checked,
    };
    
    // Basic validation
    if (!data.line1.trim() || !data.state || !data.city || !data.pincode.trim()) {
        alert('Please fill all required fields');
        return;
    }
    
    try {
        const response = await fetch('/api/cv_hub/addresses/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(data),
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addAddressModal')).hide();
            location.reload(); // Refresh to show new data
        } else {
            const errorData = await response.json();
            alert('Error saving address: ' + (errorData.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving address:', error);
        alert('Error saving address');
    }
}

async function saveContact() {
    const data = {
        entry: entryId,
        full_name: document.getElementById('contact_full_name').value,
        designation: document.getElementById('contact_designation').value,
        phone: document.getElementById('contact_phone').value,
        email: document.getElementById('contact_email').value,
        is_primary: document.getElementById('contact_is_primary').checked,
    };
    
    // Basic validation
    if (!data.full_name.trim() || !data.phone.trim()) {
        alert('Full name and phone are required');
        return;
    }
    
    try {
        const response = await fetch('/api/cv_hub/contacts/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(data),
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addContactModal')).hide();
            location.reload(); // Refresh to show new data
        } else {
            const errorData = await response.json();
            alert('Error saving contact: ' + (errorData.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving contact:', error);
        alert('Error saving contact');
    }
}
</script>
